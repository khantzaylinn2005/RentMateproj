<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Details - RentMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d9488',
                        secondary: '#0f766e',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; }
        
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #0d9488 0%, #0f766e 100%);
            padding: 2rem 0;
            z-index: 100;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0 1.5rem;
            margin-bottom: 2rem;
            color: white;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0 1rem;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1rem;
            color: rgba(255, 255, 255, 0.8);
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 500;
            text-decoration: none;
        }

        .sidebar-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .sidebar-user {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            margin-bottom: 0.75rem;
        }

        .sidebar-user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .sidebar-user-menu {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .sidebar-user-menu a {
            padding: 0.5rem 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            border-radius: 0.375rem;
            transition: all 0.2s;
            font-size: 0.875rem;
            text-decoration: none;
        }

        .sidebar-user-menu a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .main-content {
            margin-left: 260px;
            min-height: 100vh;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <i data-lucide="tent" class="w-8 h-8"></i>
            <span class="text-xl font-bold">RentMate</span>
        </div>

        <nav class="sidebar-nav">
            <a href="/dashboard.html" class="sidebar-link">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="/list_new_item.html" class="sidebar-link">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span>List New Item</span>
            </a>
            <a href="/my_items.html" class="sidebar-link">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span>My Items</span>
            </a>
            <a href="/borrowing.html" class="sidebar-link">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                <span>Borrowing</span>
            </a>
            <a href="/lending.html" class="sidebar-link">
                <i data-lucide="truck" class="w-5 h-5"></i>
                <span>Lending</span>
            </a>
            <a href="/browse_items.html" class="sidebar-link active">
                <i data-lucide="search" class="w-5 h-5"></i>
                <span>Browse Items</span>
            </a>
            <a href="/chat.html" class="sidebar-link">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span>Chat</span>
            </a>
        </nav>

        <div class="sidebar-user">
            <div class="sidebar-user-info">
                <div class="sidebar-user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="sidebarUserName" class="font-semibold text-sm">User</div>
                    <div class="text-xs text-white/70" id="userRole">Member</div>
                </div>
            </div>
            <div class="sidebar-user-menu">
                <a href="/profile.html">
                    <i data-lucide="user" class="w-4 h-4 inline mr-2"></i>
                    Profile
                </a>
                <a href="#" onclick="handleLogout()">
                    <i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i>
                    Logout
                </a>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container mx-auto px-6 py-6">
            <!-- Back Button -->
            <div class="mb-4">
                <a href="/browse_items.html" class="inline-flex items-center gap-2 text-gray-600 hover:text-gray-900 font-semibold">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    Back to Browse
                </a>
            </div>

            <!-- Item Detail Card -->
            <div id="itemDetail" class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <!-- Loading state -->
                <div class="p-8 text-center">
                    <p class="text-gray-600">Loading...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script>
        // Check authentication
        if (!currentUser) {
            window.location.href = '/login.html';
        }

        // Update sidebar user info
        if (currentUser) {
            document.getElementById('sidebarUserName').textContent = currentUser.name || 'User';
            document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Admin' : 'Member';
            document.getElementById('userAvatar').textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
        }

        // Get item ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const itemId = urlParams.get('id');

        if (!itemId) {
            window.location.href = '/browse_items.html';
        }

        async function loadItemDetail() {
            try {
                const response = await api.getItems();
                const item = (response.data || []).find(i => i.id == itemId);
                
                if (!item) {
                    Swal.fire('Error', 'Item not found', 'error').then(() => {
                        window.location.href = '/browse_items.html';
                    });
                    return;
                }

                displayItemDetail(item);
            } catch (error) {
                console.error('Error loading item:', error);
                Swal.fire('Error', 'Failed to load item details', 'error');
            }
        }

        function displayItemDetail(item) {
            const itemDetail = document.getElementById('itemDetail');
            
            // Parse images JSON string
            let images = [];
            try {
                images = item.images ? JSON.parse(item.images) : [];
            } catch (e) {
                console.error('Error parsing images:', e);
                images = [];
            }
            
            // Handle image placeholder
            const imageHtml = images && images.length > 0 && images[0] ? 
                `<img src="${images[0]}" alt="${item.name}" class="w-full h-96 object-cover">` :
                `<div class="w-full h-96 bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center">
                    <i data-lucide="package" class="w-32 h-32 text-gray-500"></i>
                </div>`;
            
            itemDetail.innerHTML = `
                ${imageHtml}
                
                <div class="p-6">
                    <!-- Header -->
                    <div class="mb-6">
                        <div class="flex items-start justify-between mb-2">
                            <h1 class="text-3xl font-bold text-gray-900">${item.name}</h1>
                            ${!item.available ? '<span class="px-3 py-1 bg-red-500 text-white text-sm font-bold rounded uppercase">Rented</span>' : ''}
                        </div>
                        <div class="flex items-center gap-4 text-sm text-gray-600">
                            <span class="flex items-center gap-1">
                                <i data-lucide="map-pin" class="w-4 h-4"></i>
                                ${item.location || 'Location not specified'}
                            </span>
                            <span class="flex items-center gap-1">
                                <i data-lucide="tag" class="w-4 h-4"></i>
                                ${item.category || 'Other'}
                            </span>
                        </div>
                    </div>

                    <!-- Price -->
                    <div class="mb-6">
                        <div class="inline-block p-6 bg-gray-900 rounded-lg">
                            <div class="text-sm text-gray-400 uppercase tracking-wide mb-1">Price per day</div>
                            <div class="text-4xl font-bold text-white">$${item.price}</div>
                        </div>
                    </div>

                    <!-- Info Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Condition</div>
                            <div class="text-sm font-bold text-gray-900 uppercase">${item.condition_status || 'Good'}</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Category</div>
                            <div class="text-sm font-bold text-gray-900 uppercase">${item.category || 'Other'}</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Deposit</div>
                            <div class="text-sm font-bold text-gray-900">$${item.deposit || 0}</div>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Status</div>
                            <div class="text-sm font-bold ${item.available ? 'text-green-700' : 'text-red-700'} uppercase">
                                ${item.available ? 'Available' : 'Rented'}
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-gray-900 mb-3 uppercase tracking-wide">Description</h2>
                        <p class="text-gray-700 leading-relaxed">${item.description || 'No description available for this item.'}</p>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4">
                        <a href="/browse_items.html" 
                            class="px-6 py-3 bg-gray-200 text-gray-900 font-bold rounded-lg hover:bg-gray-300 transition-colors uppercase tracking-wide">
                            <i data-lucide="arrow-left" class="w-5 h-5 inline mr-2"></i>
                            Back to Browse
                        </a>
                        ${item.available ? `
                            <button onclick="requestRental(${item.id})" 
                                class="flex-1 px-6 py-3 bg-black text-white font-bold rounded-lg hover:bg-gray-800 transition-colors uppercase tracking-wide">
                                <i data-lucide="shopping-bag" class="w-5 h-5 inline mr-2"></i>
                                Request Rental
                            </button>
                        ` : `
                            <button disabled 
                                class="flex-1 px-6 py-3 bg-gray-400 text-white font-bold rounded-lg cursor-not-allowed uppercase tracking-wide">
                                Currently Unavailable
                            </button>
                        `}
                    </div>
                </div>
            `;
            
            lucide.createIcons();
        }

        async function requestRental(itemId) {
            const { value: formValues } = await Swal.fire({
                title: 'Request Rental',
                html: `
                    <div class="text-left space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Start Date</label>
                            <input type="date" id="startDate" class="swal2-input w-full" min="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">End Date</label>
                            <input type="date" id="endDate" class="swal2-input w-full" min="${new Date().toISOString().split('T')[0]}">
                        </div>
                    </div>
                `,
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'Submit Request',
                confirmButtonColor: '#000000',
                preConfirm: () => {
                    const startDate = document.getElementById('startDate').value;
                    const endDate = document.getElementById('endDate').value;
                    
                    if (!startDate || !endDate) {
                        Swal.showValidationMessage('Please select both start and end dates');
                        return false;
                    }
                    
                    if (new Date(endDate) <= new Date(startDate)) {
                        Swal.showValidationMessage('End date must be after start date');
                        return false;
                    }
                    
                    return { startDate, endDate };
                }
            });

            if (formValues) {
                try {
                    const response = await api.getItems();
                    const item = (response.data || []).find(i => i.id == itemId);
                    
                    const days = Math.ceil((new Date(formValues.endDate) - new Date(formValues.startDate)) / (1000 * 60 * 60 * 24));
                    const totalPrice = days * item.price;
                    
                    const rentalData = {
                        item_id: itemId,
                        start_date: formValues.startDate,
                        end_date: formValues.endDate,
                        total_price: totalPrice
                    };
                    
                    await api.createRental(rentalData);
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Request Sent!',
                        text: `Your rental request has been sent to the owner.`,
                        confirmButtonColor: '#000000'
                    }).then(() => {
                        window.location.href = '/borrowing.html';
                    });
                } catch (error) {
                    console.error('Error creating rental:', error);
                    Swal.fire('Error', error.message || 'Failed to create rental request', 'error');
                }
            }
        }

        // Initialize page
        window.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await loadItemDetail();
        });
    </script>
</body>
</html>
