<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rentals Management - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d9488',
                        secondary: '#0f766e',
                    },
                    fontFamily: {
                        sans: ['Manrope', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Admin Navigation Tabs */
        .admin-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .admin-tab {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .admin-tab:hover {
            background-color: #f0fdfa;
        }

        .admin-tab.active {
            background-color: #0d9488;
            color: white;
        }

        /* Progress Tracker */
        .progress-tracker {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding: 16px 0;
            min-width: 600px;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            z-index: 1;
        }

        .progress-step-circle {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 4px solid #f3f4f6;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 1px 3px rgba(0, 0, 0, 0.06);
            position: relative;
        }

        .progress-step.active .progress-step-circle {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.15), 0 8px 16px rgba(59, 130, 246, 0.3);
            transform: scale(1.15);
            animation: pulse-blue 2s infinite;
        }

        .progress-step.completed .progress-step-circle {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4), 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.15), 0 8px 16px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0.1), 0 8px 16px rgba(59, 130, 246, 0.4); }
        }

        .progress-step.cancelled .progress-step-circle {
            background-color: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .progress-step-label {
            margin-top: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            text-align: center;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-step.active .progress-step-label {
            color: #3b82f6;
            font-weight: 700;
        }

        .progress-step.completed .progress-step-label {
            color: #10b981;
            font-weight: 600;
        }

        .progress-step.cancelled .progress-step-label {
            color: #ef4444;
        }

        .progress-step-desc {
            margin-top: 4px;
            font-size: 10px;
            color: #9ca3af;
            text-align: center;
            line-height: 1.2;
            max-width: 90px;
        }

        .progress-step.active .progress-step-desc {
            color: #60a5fa;
            font-weight: 500;
        }

        .progress-step.completed .progress-step-desc {
            color: #6ee7b7;
        }

        .progress-line {
            position: absolute;
            top: 40px;
            left: 8%;
            right: 8%;
            height: 4px;
            background-color: #e5e7eb;
            z-index: 0;
            border-radius: 2px;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(to right, #10b981, #059669);
            transition: width 0.5s ease;
            border-radius: 2px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        /* Responsive Navigation */
        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
            }
            
            .admin-tab {
                width: 100%;
                justify-content: flex-start;
            }

            .top-nav-links {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }

            .progress-tracker {
                min-width: 500px !important;
                padding: 12px 0;
            }

            .progress-step-label {
                font-size: 11px;
            }

            .progress-step-circle {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .progress-line {
                left: 10%;
                right: 10%;
                top: 36px;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i data-lucide="shield" class="w-7 h-7 text-yellow-500"></i>
                    <span class="text-xl font-bold text-gray-800">RentMate Admin</span>
                </div>
                <div class="flex items-center space-x-6 top-nav-links">
                    <a href="/index.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="home" class="w-4 h-4 inline mr-1"></i>
                        Home
                    </a>
                    <a href="/dashboard.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-1"></i>
                        Dashboard
                    </a>
                    <button onclick="handleLogout()" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                        Logout
                    </button>
                </div>
                <button class="mobile-menu-btn text-gray-700" onclick="toggleMobileMenu()">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Admin Tabs -->
        <div class="bg-white rounded-lg shadow mb-8 p-4">
            <div class="admin-tabs">
                <button onclick="window.location.href='/admin.html'" class="admin-tab">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span>Users</span>
                </button>
                <button onclick="window.location.href='/admin/items.html'" class="admin-tab">
                    <i data-lucide="package" class="w-4 h-4"></i>
                    <span>Items</span>
                </button>
                <button onclick="window.location.href='/admin/rentals.html'" class="admin-tab active">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Rentals</span>
                </button>
                <button onclick="window.location.href='/admin/rental_management.html'" class="admin-tab">
                    <i data-lucide="workflow" class="w-4 h-4"></i>
                    <span>Rental Workflow</span>
                </button>
                <button onclick="window.location.href='/admin/verification.html'" class="admin-tab">
                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                    <span>Verifications</span>
                </button>
                <button onclick="window.location.href='/admin/item_approval.html'" class="admin-tab">
                    <i data-lucide="package-check" class="w-4 h-4"></i>
                    <span>Item Approvals</span>
                </button>
                <button onclick="window.location.href='/admin/banking.html'" class="admin-tab">
                    <i data-lucide="credit-card" class="w-4 h-4"></i>
                    <span>Banking</span>
                </button>
                <button onclick="window.location.href='/admin/statistics.html'" class="admin-tab">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    <span>Statistics</span>
                </button>
                <button onclick="window.location.href='/admin/support.html'" class="admin-tab">
                    <i data-lucide="life-buoy" class="w-4 h-4"></i>
                    <span>Customer Support</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Rentals Management</h2>
                <div class="flex flex-col gap-3 md:flex-row md:items-center">
                    <div class="relative">
                        <input type="text" id="rentalSearch" placeholder="Search rentals by ID, borrower, lender, or item" class="w-full md:w-80 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary" />
                        <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"></i>
                    </div>
                    <select id="workflowFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                        <option value="all">All statuses</option>
                        <option value="payment_pending">Payment Pending</option>
                        <option value="payment_made">Payment Made</option>
                        <option value="approved">Approved</option>
                        <option value="lender_confirmed">Lender Confirmed</option>
                        <option value="active">Active</option>
                        <option value="borrower_returned">Borrower Returned</option>
                        <option value="return_completed">Return Completed</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Total Rentals</p>
                            <p id="totalRentals" class="text-2xl font-bold text-gray-900">0</p>
                        </div>
                        <i data-lucide="calendar" class="w-10 h-10 text-blue-500"></i>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Active</p>
                            <p id="activeRentals" class="text-2xl font-bold text-green-600">0</p>
                        </div>
                        <i data-lucide="clock" class="w-10 h-10 text-green-500"></i>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Completed</p>
                            <p id="completedRentals" class="text-2xl font-bold text-gray-600">0</p>
                        </div>
                        <i data-lucide="check-circle" class="w-10 h-10 text-gray-500"></i>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6 border border-gray-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Pending</p>
                            <p id="pendingRentals" class="text-2xl font-bold text-orange-600">0</p>
                        </div>
                        <i data-lucide="alert-circle" class="w-10 h-10 text-orange-500"></i>
                    </div>
                </div>
            </div>

            <!-- Rentals Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rental ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Item</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Borrower</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lender</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Start Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">End Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rentalsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Rentals will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
                <p class="mt-4 text-gray-600">Loading rentals...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden text-center py-12">
                <i data-lucide="inbox" class="w-16 h-16 mx-auto text-gray-400 mb-4"></i>
                <p class="text-xl text-gray-600">No rentals found</p>
            </div>

            <!-- Pagination -->
            <div class="mt-6 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                <p id="paginationInfo" class="text-sm text-gray-600"></p>
                <div id="pagination" class="flex flex-wrap gap-2"></div>
            </div>
        </div>
    </div>

    <script src="../app.js"></script>
    <script>
        const PAGE_SIZE = 5;
        const statusStepMap = {
            pending: 1,
            payment_pending: 1,
            requested: 1,
            pending_payment: 2,
            payment_made: 2,
            payment_approved: 3,
            approved: 3,
            lender_confirmed: 4,
            active: 5,
            ongoing: 5,
            item_received: 5,
            item_transferred: 5,
            borrower_returned: 6,
            return_completed: 7,
            returned: 7,
            return_confirmed: 7,
            completed: 8,
            cancelled: 0,
            rejected: 0
        };

        let allRentals = [];
        let filteredRentals = [];
        let rentalMap = {};
        let currentPage = 1;

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            if (menu) menu.classList.toggle('hidden');
        }

        function formatCurrency(amount) {
            const value = Number.parseFloat(amount || 0);
            return `à¸¿${Number.isNaN(value) ? '0.00' : value.toFixed(2)}`;
        }

        function formatDateTime(value) {
            return value ? new Date(value).toLocaleString() : 'N/A';
        }

        function sanitizeKey(key) {
            return String(key ?? '').trim();
        }

        function debounce(fn, delay = 250) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(null, args), delay);
            };
        }

        function renderStatusBadge(statusRaw) {
            const status = (statusRaw || 'unknown').toString().toLowerCase();
            const statusMeta = {
                payment_pending: { label: 'Payment Pending', classes: 'bg-yellow-100 text-yellow-800' },
                payment_made: { label: 'Payment Made', classes: 'bg-blue-100 text-blue-800' },
                approved: { label: 'Approved', classes: 'bg-green-100 text-green-800' },
                lender_confirmed: { label: 'Lender Confirmed', classes: 'bg-indigo-100 text-indigo-800' },
                active: { label: 'Active', classes: 'bg-teal-100 text-teal-800' },
                borrower_returned: { label: 'Borrower Returned', classes: 'bg-orange-100 text-orange-800' },
                return_completed: { label: 'Return Completed', classes: 'bg-purple-100 text-purple-800' },
                completed: { label: 'Completed', classes: 'bg-gray-200 text-gray-800' },
                cancelled: { label: 'Cancelled', classes: 'bg-red-100 text-red-700' },
                rejected: { label: 'Rejected', classes: 'bg-red-100 text-red-700' }
            };

            const meta = statusMeta[status] || { label: statusRaw || 'Unknown', classes: 'bg-gray-100 text-gray-700' };
            return `<span class="inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full ${meta.classes}">${meta.label}</span>`;
        }

        async function loadRentals() {
            try {
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('emptyState').classList.add('hidden');

                const response = await api.getAllRentals();

                if (Array.isArray(response)) {
                    allRentals = response;
                } else if (response?.rentals && Array.isArray(response.rentals)) {
                    allRentals = response.rentals;
                } else if (response?.data && Array.isArray(response.data)) {
                    allRentals = response.data;
                } else {
                    allRentals = [];
                }

                rentalMap = {};
                allRentals.forEach(rental => {
                    const key = sanitizeKey(rental.id ?? rental.rental_id ?? rental.rentalId);
                    if (key) {
                        rentalMap[key] = rental;
                    }
                });

                applyFilters();
            } catch (error) {
                console.error('Error loading rentals:', error);
                Swal.fire('Error', 'Failed to load rentals', 'error');
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
                lucide.createIcons();
            }
        }

        function updateStats() {
            const total = allRentals.length;
            const active = allRentals.filter(r => (r.workflow_status || r.status) === 'active' || (r.workflow_status || r.status) === 'ongoing').length;
            const completed = allRentals.filter(r => (r.workflow_status || r.status) === 'completed' || (r.workflow_status || r.status) === 'returned').length;
            const pending = allRentals.filter(r => (r.workflow_status || r.status) === 'pending' || (r.workflow_status || r.status) === 'requested' || (r.workflow_status || r.status) === 'payment_pending').length;

            document.getElementById('totalRentals').textContent = total;
            document.getElementById('activeRentals').textContent = active;
            document.getElementById('completedRentals').textContent = completed;
            document.getElementById('pendingRentals').textContent = pending;
        }

        function applyFilters() {
            const searchTerm = (document.getElementById('rentalSearch').value || '').toLowerCase();
            const statusFilter = document.getElementById('workflowFilter').value;

            filteredRentals = allRentals.filter(rental => {
                const status = (rental.workflow_status || rental.status || '').toLowerCase();
                const matchesStatus = statusFilter === 'all' || status === statusFilter;

                if (!matchesStatus) return false;

                if (!searchTerm) return true;

                const text = [
                    rental.rental_id,
                    rental.id,
                    rental.itemName,
                    rental.item_name,
                    rental.borrowerName,
                    rental.borrower_email,
                    rental.borrowerEmail,
                    rental.lenderName,
                    rental.lender_email,
                    rental.lenderEmail
                ].join(' ').toLowerCase();

                return text.includes(searchTerm);
            });

            currentPage = 1;
            updateStats();
            renderRentals();
            renderPagination();
        }

        function getProgressStep(status) {
            const normalized = (status || '').toString().toLowerCase();
            return statusStepMap[normalized] ?? 1;
        }

        function buildProgressMarkup(rental, key, currentStep, isCancelled) {
            const steps = [
                { number: 1, label: isCancelled ? 'Cancelled' : 'Payment', desc: isCancelled ? 'Request cancelled' : 'Payment submitted', icon: 'ti ti-credit-card', completedIcon: 'ti ti-check', cancelledIcon: 'ti ti-x', type: 'payment' },
                { number: 2, label: 'Verified', desc: 'Admin approved', icon: 'ti ti-circle-check', completedIcon: 'ti ti-check', type: 'verification' },
                { number: 3, label: 'Handed Over', desc: 'Lender confirmed', icon: 'ti ti-package', completedIcon: 'ti ti-check', type: 'handover' },
                { number: 4, label: 'Received', desc: 'Borrower got item', icon: 'ti ti-hand-grab', completedIcon: 'ti ti-check', type: 'borrower_received' },
                { number: 5, label: 'In Use', desc: 'Rental active', icon: 'ti ti-refresh', completedIcon: 'ti ti-check', type: 'active' },
                { number: 6, label: 'Returning', desc: 'Borrower return proof', icon: 'ti ti-camera', completedIcon: 'ti ti-check', type: 'borrower_return' },
                { number: 7, label: 'Returned', desc: 'Lender confirmation', icon: 'ti ti-photo', completedIcon: 'ti ti-check', type: 'lender_return' },
                { number: 8, label: 'Complete', desc: 'All settled', icon: 'ti ti-hourglass', completedIcon: 'ti ti-circle-check-filled', type: 'final' }
            ];

            return steps.map(step => {
                const completed = !isCancelled && currentStep > step.number;
                const active = !isCancelled && currentStep === step.number;
                const cancelled = isCancelled && step.number === 1;
                const classes = ['progress-step'];

                if (completed || (step.number === currentStep && currentStep >= steps.length && !isCancelled)) {
                    classes.push('completed');
                }
                if (active) {
                    classes.push('active');
                }
                if (cancelled) {
                    classes.push('cancelled');
                }

                classes.push('cursor-pointer');

                let iconClass = step.icon;
                if (cancelled) {
                    iconClass = step.cancelledIcon;
                } else if (!isCancelled && currentStep >= step.number) {
                    iconClass = currentStep > step.number ? step.completedIcon : step.icon;
                    if (step.number === steps.length && currentStep >= step.number) {
                        iconClass = step.completedIcon;
                    }
                }

                return `
                    <div class="${classes.join(' ')}" onclick="showStepProof('${key}', '${step.type}')">
                        <div class="progress-step-circle"><i class="${iconClass}"></i></div>
                        <div class="progress-step-label">${step.label}</div>
                        <div class="progress-step-desc">${step.desc}</div>
                    </div>
                `;
            }).join('');
        }

        function renderRentals() {
            const tbody = document.getElementById('rentalsTableBody');
            const paginationInfo = document.getElementById('paginationInfo');

            if (!filteredRentals.length) {
                tbody.innerHTML = '';
                document.getElementById('emptyState').classList.remove('hidden');
                if (paginationInfo) {
                    paginationInfo.textContent = 'Showing 0 rentals';
                }
                const pagination = document.getElementById('pagination');
                if (pagination) {
                    pagination.innerHTML = '';
                }
                return;
            }

            document.getElementById('emptyState').classList.add('hidden');

            const startIndex = (currentPage - 1) * PAGE_SIZE;
            const pageItems = filteredRentals.slice(startIndex, startIndex + PAGE_SIZE);

            const rows = pageItems.map(rental => {
                const keyRaw = sanitizeKey(rental.id ?? rental.rental_id ?? rental.rentalId);
                const safeKey = keyRaw.replace(/'/g, "\\'");
                const currentStep = getProgressStep(rental.workflow_status || rental.status);
                const isCancelled = (rental.workflow_status || rental.status) === 'cancelled' || (rental.workflow_status || rental.status) === 'rejected';
                const fillPercent = isCancelled ? 0 : Math.max(0, Math.min(7, currentStep - 1)) / 7 * 100;

                return `
                    <tr class="hover:bg-gray-50 border-b-0">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${rental.rental_id || rental.id || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${rental.itemName || rental.item_name || rental.item?.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${rental.borrowerName || rental.borrower_name || rental.borrower?.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${rental.lenderName || rental.lender_name || rental.lender?.name || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${rental.start_date ? new Date(rental.start_date).toLocaleDateString() : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${rental.end_date ? new Date(rental.end_date).toLocaleDateString() : 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${formatCurrency(rental.total_price || rental.total)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${renderStatusBadge(rental.workflow_status || rental.status)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="inline-flex items-center px-3 py-1.5 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition" onclick="viewRentalDetails('${safeKey}')">
                                <i data-lucide="eye" class="w-4 h-4 mr-1"></i>
                                View
                            </button>
                        </td>
                    </tr>
                    <tr class="bg-gray-50 hover:bg-gray-100">
                        <td colspan="9" class="px-6 py-6">
                            <div class="progress-tracker" style="min-width: 800px;">
                                <div class="progress-line">
                                    <div class="progress-line-fill" style="width: ${fillPercent}%;"></div>
                                </div>
                                ${buildProgressMarkup(rental, safeKey, currentStep, isCancelled)}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rows;

            if (paginationInfo) {
                const endIndex = Math.min(filteredRentals.length, startIndex + PAGE_SIZE);
                paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${filteredRentals.length} rentals`;
            }

            lucide.createIcons();
        }

        function renderPagination() {
            const pagination = document.getElementById('pagination');
            if (!pagination) return;

            if (filteredRentals.length === 0) {
                pagination.innerHTML = '';
                return;
            }

            const totalPages = Math.max(1, Math.ceil(filteredRentals.length / PAGE_SIZE));
            pagination.innerHTML = '';

            const createButton = (label, page, disabled = false, active = false) => {
                const button = document.createElement('button');
                button.textContent = label;
                button.className = `px-3 py-1 rounded-md border text-sm font-medium transition ${active ? 'bg-primary text-white border-primary' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'} ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`;
                if (!disabled) {
                    button.addEventListener('click', () => {
                        currentPage = page;
                        renderRentals();
                        renderPagination();
                    });
                }
                pagination.appendChild(button);
            };

            createButton('Prev', Math.max(1, currentPage - 1), currentPage === 1);

            for (let page = 1; page <= totalPages; page++) {
                createButton(page, page, false, page === currentPage);
            }

            createButton('Next', Math.min(totalPages, currentPage + 1), currentPage === totalPages);
        }

        function showStepProof(key, type) {
            const rental = rentalMap[sanitizeKey(key)];
            if (!rental) {
                Swal.fire('Rental not found', 'Unable to load rental details for this step.', 'error');
                return;
            }

            const sections = [];
            const statusValue = (rental.workflow_status || rental.status || '').toLowerCase();
            const isCancelled = statusValue === 'cancelled' || statusValue === 'rejected';

            const addImage = (title, url) => {
                if (!url) return;
                sections.push(`
                    <div class="space-y-2">
                        <h4 class="text-sm font-semibold text-gray-700">${title}</h4>
                        <div class="border rounded-lg overflow-hidden">
                            <img src="${url}" alt="${title}" class="w-full object-contain" />
                        </div>
                    </div>
                `);
            };

            const addInfo = (label, value) => {
                sections.push(`<p class="text-sm text-gray-600"><span class="font-semibold text-gray-800">${label}:</span> ${value}</p>`);
            };

            switch (type) {
                case 'payment':
                    addInfo('Payment Date', formatDateTime(rental.payment_date));
                    addImage('Borrower Payment Slip', rental.payment_slip);
                    if (isCancelled) {
                        addInfo('Cancellation Status', 'Request was cancelled by admin');
                        if (rental.rejection_reason) {
                            addInfo('Reason Provided', rental.rejection_reason);
                        }
                        addInfo('Processed At', formatDateTime(rental.rejected_at));
                        addImage('Admin Refund Slip', rental.admin_reject_refund_slip || rental.admin_refund_slip);
                    }
                    break;
                case 'verification':
                    addInfo('Admin Approved At', formatDateTime(rental.admin_approved_at));
                    addInfo('Workflow Status', (rental.workflow_status || 'Unknown').toUpperCase());
                    break;
                case 'handover':
                    addInfo('Lender Confirmed Transfer', formatDateTime(rental.lender_confirmed_transfer_at));
                    addImage('Lender Handover Photo', rental.lender_transfer_photo);
                    break;
                case 'borrower_received':
                    addInfo('Borrower Confirmed Receipt', formatDateTime(rental.borrower_confirmed_receipt_at));
                    addInfo('Message', 'Borrower acknowledged receiving the item.');
                    addImage('Borrower Receipt Photo', rental.borrower_receive_photo);
                    break;
                case 'active':
                    addInfo('Rental Active Since', formatDateTime(rental.borrower_confirmed_receipt_at));
                    addInfo('End Date', formatDateTime(rental.end_date));
                    break;
                case 'borrower_return':
                    addInfo('Borrower Confirmed Return', formatDateTime(rental.borrower_confirmed_return_at));
                    addImage('Borrower Return Photo', rental.borrower_return_photo);
                    break;
                case 'lender_return':
                    addInfo('Lender Confirmed Return', formatDateTime(rental.lender_confirmed_return_at));
                    addImage('Lender Return Photo', rental.lender_return_photo);
                    break;
                case 'final':
                    addInfo('Admin Processed Payment', formatDateTime(rental.admin_processed_payment_at));
                    addImage('Admin Payment Slip to Lender', rental.admin_lender_payment_slip);
                    addImage('Admin Deposit Refund Slip', rental.admin_refund_slip);
                    break;
                default:
                    sections.push('<p class="text-sm text-gray-600">No additional information available for this step.</p>');
            }

            const hasProof = sections.some(section => section.includes('<img'));

            Swal.fire({
                title: hasProof ? 'Proof & Details' : 'Step Details',
                html: `
                    <div class="text-left space-y-4">
                        ${sections.join('\n') || '<p class="text-sm text-gray-600">No proof has been uploaded for this step yet.</p>'}
                    </div>
                `,
                width: hasProof ? 700 : 500,
                showCloseButton: true,
                confirmButtonText: 'Close',
                confirmButtonColor: '#0d9488'
            });
        }

        function viewRentalDetails(key) {
            const rental = rentalMap[sanitizeKey(key)];
            if (!rental) {
                Swal.fire('Rental not found', 'Unable to load rental details.', 'error');
                return;
            }

            const deposit = formatCurrency((parseFloat(rental.total_price || 0) || 0) * 0.2);
            const statusValue = (rental.workflow_status || rental.status || '').toLowerCase();
            const isCancelled = statusValue === 'cancelled' || statusValue === 'rejected';
            const escapedKey = key.replace(/'/g, "\\'");

            const cancellationSection = isCancelled ? `
                <div>
                    <h3 class="text-lg font-semibold text-red-600 mt-4">Cancellation Details</h3>
                    <div class="mt-2 space-y-2 text-sm text-gray-700">
                        <p><span class="font-semibold">Status:</span> ${statusValue === 'rejected' ? 'Rejected by Admin' : 'Cancelled'}</p>
                        <p><span class="font-semibold">Processed At:</span> ${formatDateTime(rental.rejected_at)}</p>
                        <p><span class="font-semibold">Reason:</span> ${rental.rejection_reason || 'No reason provided'}</p>
                        ${rental.admin_reject_refund_slip ? `<button class="px-4 py-2 text-sm font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700 transition" onclick="showStepProof('${escapedKey}', 'payment')">View Refund Proof</button>` : ''}
                    </div>
                </div>
            ` : '';

            const quickActions = `
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Quick Actions</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <button class="px-4 py-2 text-sm font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition" onclick="showStepProof('${escapedKey}', 'payment')">View Payment Slip</button>
                        <button class="px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition" onclick="showStepProof('${escapedKey}', 'handover')">Handover Photo</button>
                        <button class="px-4 py-2 text-sm font-semibold text-white bg-sky-600 rounded-lg hover:bg-sky-700 transition" onclick="showStepProof('${escapedKey}', 'borrower_received')">Borrower Receipt</button>
                        <button class="px-4 py-2 text-sm font-semibold text-white bg-orange-600 rounded-lg hover:bg-orange-700 transition" onclick="showStepProof('${escapedKey}', 'borrower_return')">Borrower Return</button>
                        <button class="px-4 py-2 text-sm font-semibold text-white bg-purple-600 rounded-lg hover:bg-purple-700 transition" onclick="showStepProof('${escapedKey}', 'lender_return')">Lender Return</button>
                        <button class="px-4 py-2 text-sm font-semibold text-white bg-emerald-600 rounded-lg hover:bg-emerald-700 transition" onclick="showStepProof('${escapedKey}', 'final')">Final Payment Proof</button>
                    </div>
                </div>`;

            Swal.fire({
                title: `Rental ${rental.rental_id || rental.id || ''}`,
                html: `
                    <div class="text-left space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">General Information</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2 text-sm text-gray-700">
                                <p><span class="font-semibold">Item:</span> ${rental.itemName || 'N/A'}</p>
                                <p><span class="font-semibold">Workflow Status:</span> ${(rental.workflow_status || 'Unknown').toUpperCase()}</p>
                                <p><span class="font-semibold">Borrower:</span> ${rental.borrowerName || 'N/A'}</p>
                                <p><span class="font-semibold">Lender:</span> ${rental.lenderName || 'N/A'}</p>
                                <p><span class="font-semibold">Start Date:</span> ${formatDateTime(rental.start_date)}</p>
                                <p><span class="font-semibold">End Date:</span> ${formatDateTime(rental.end_date)}</p>
                                <p><span class="font-semibold">Total Price:</span> ${formatCurrency(rental.total_price)}</p>
                                <p><span class="font-semibold">Deposit (20%):</span> ${deposit}</p>
                            </div>
                        </div>
                        ${quickActions}
                        ${cancellationSection}
                    </div>
                `,
                width: 700,
                confirmButtonText: 'Close',
                confirmButtonColor: '#0d9488',
                showCloseButton: true
            });
        }

        function handleLogout() {
            localStorage.clear();
            window.location.href = '../login.html';
        }

        window.showStepProof = showStepProof;
        window.viewRentalDetails = viewRentalDetails;

        const debouncedSearch = debounce(() => applyFilters(), 300);
        document.getElementById('rentalSearch').addEventListener('input', debouncedSearch);
        document.getElementById('workflowFilter').addEventListener('change', applyFilters);

        loadRentals();
        lucide.createIcons();
    </script>
</body>
</html>
