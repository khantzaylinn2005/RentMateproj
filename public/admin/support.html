<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Support - RentMate Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Manrope', sans-serif;
            background-color: #f8fafc;
        }

        .admin-tab {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            border-radius: 0.75rem;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.375rem;
            border: none;
            background: transparent;
        }

        .admin-tab:hover {
            background-color: #f0fdfa;
        }

        .admin-tab.active {
            background-color: #0f766e;
            color: #ffffff;
            box-shadow: 0 10px 18px -12px rgba(15, 118, 110, 0.8);
        }

        .support-card {
            border-radius: 1.25rem;
            border: 1px solid rgba(15, 118, 110, 0.12);
            background: linear-gradient(135deg, rgba(255,255,255,0.96), rgba(247,250,252,0.96));
            box-shadow: 0 24px 48px -32px rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(14px);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.82);
            border: 1px solid rgba(148, 163, 184, 0.18);
            box-shadow: 0 20px 45px -30px rgba(15, 23, 42, 0.38);
            backdrop-filter: blur(16px);
        }

        .floating-badge {
            border-radius: 9999px;
            border: 1px solid rgba(20, 184, 166, 0.18);
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.16), rgba(236, 253, 245, 0.38));
        }

        .soft-button {
            transition: all 0.2s ease;
            border-radius: 0.9rem;
            border-width: 1px;
            padding: 0.65rem 1.2rem;
        }

        .soft-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 22px -18px rgba(13, 148, 136, 0.55);
        }
    </style>
</head>
<body>
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i data-lucide="shield" class="w-7 h-7 text-teal-600"></i>
                    <span class="text-xl font-bold text-gray-800">RentMate Admin</span>
                </div>
                <div class="flex items-center space-x-6 top-nav-links">
                    <a href="/index.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="home" class="w-4 h-4 inline mr-1"></i>
                        Home
                    </a>
                    <a href="/dashboard.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-1"></i>
                        Dashboard
                    </a>
                    <button onclick="handleLogout()" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                        Logout
                    </button>
                </div>
                <button class="mobile-menu-btn text-gray-700" onclick="toggleMobileMenu()">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <div class="glass-panel rounded-2xl mb-10 px-5 py-4">
            <div class="flex flex-wrap gap-2">
                <button onclick="window.location.href='/admin.html'" class="admin-tab">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span>Users</span>
                </button>
                <button onclick="window.location.href='/admin/items.html'" class="admin-tab">
                    <i data-lucide="package" class="w-4 h-4"></i>
                    <span>Items</span>
                </button>
                <button onclick="window.location.href='/admin/rentals.html'" class="admin-tab">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Rentals</span>
                </button>
                <button onclick="window.location.href='/admin/rental_management.html'" class="admin-tab">
                    <i data-lucide="workflow" class="w-4 h-4"></i>
                    <span>Rental Workflow</span>
                </button>
                <button onclick="window.location.href='/admin/verification.html'" class="admin-tab">
                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                    <span>Verifications</span>
                </button>
                <button onclick="window.location.href='/admin/item_approval.html'" class="admin-tab">
                    <i data-lucide="package-check" class="w-4 h-4"></i>
                    <span>Item Approvals</span>
                </button>
                <button onclick="window.location.href='/admin/banking.html'" class="admin-tab">
                    <i data-lucide="credit-card" class="w-4 h-4"></i>
                    <span>Banking</span>
                </button>
                <button onclick="window.location.href='/admin/statistics.html'" class="admin-tab">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    <span>Statistics</span>
                </button>
                <button onclick="window.location.href='/admin/support.html'" class="admin-tab active">
                    <i data-lucide="life-buoy" class="w-4 h-4"></i>
                    <span>Customer Support</span>
                </button>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-6 mb-10">
            <div class="support-card flex-1 p-6 lg:p-8">
                <div class="flex items-start gap-4">
                    <div class="floating-badge p-3 text-teal-600">
                        <i data-lucide="headset" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-xs uppercase tracking-[0.35em] text-teal-500/70 mb-2">Support Command Center</p>
                        <h2 class="text-2xl font-bold text-gray-800 leading-tight">Stay on top of incoming requests</h2>
                        <p class="text-sm text-gray-500 mt-2">Refresh tickets frequently, leave context-rich notes, and close loops with borrowers and lenders quickly.</p>
                    </div>
                </div>
            </div>
            <div class="support-card w-full lg:w-80 p-6 bg-gradient-to-br from-teal-600 via-emerald-500 to-teal-500 text-white">
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 rounded-full p-3">
                        <i data-lucide="clock" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <p class="text-sm uppercase tracking-wide text-white/80">Average resolution</p>
                        <p class="text-2xl font-bold">6h 42m</p>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-white/80">Keep this time low by resolving tickets quickly and leaving clear responses for users.</p>
                </div>
            </div>
        </div>

        <div class="support-card p-6 lg:p-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-teal-500/70 mb-2">Ticket Management</p>
                    <h3 class="text-2xl font-semibold text-gray-800">Support Tickets</h3>
                    <p class="text-sm text-gray-500">Focus on open cases first. Use quick filters and refresh to keep data current.</p>
                </div>
                <div class="flex items-center gap-3">
                    <button id="filterOpen" class="soft-button bg-teal-50 text-teal-700 border border-teal-200">Open Only</button>
                    <button id="filterAll" class="soft-button bg-slate-100 text-slate-600 border border-slate-200">All Tickets</button>
                    <button id="refreshTickets" class="soft-button bg-white text-slate-600 border border-slate-200 hover:bg-slate-50">
                        <i data-lucide="refresh-ccw" class="w-4 h-4 inline mr-2"></i>
                        Refresh
                    </button>
                </div>
            </div>

            <div id="ticketsContainer" class="space-y-5"></div>
            <div id="ticketsEmpty" class="hidden border border-dashed border-slate-200 rounded-2xl p-12 text-center text-slate-500 bg-white/70">
                <i data-lucide="life-buoy" class="w-12 h-12 mx-auto mb-4 text-slate-400"></i>
                <h4 class="text-lg font-semibold text-slate-800 mb-1">No tickets to display</h4>
                <p class="text-sm">Great job! There are no support tickets requiring attention right now.</p>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script>
        if (!currentUser || currentUser.role !== 'admin') {
            window.location.href = '/login.html';
        }

        const ticketsContainer = document.getElementById('ticketsContainer');
        const ticketsEmpty = document.getElementById('ticketsEmpty');
        const filterOpenBtn = document.getElementById('filterOpen');
        const filterAllBtn = document.getElementById('filterAll');
        const refreshBtn = document.getElementById('refreshTickets');

        let allTickets = [];
        let showOpenOnly = true;

        function toggleMobileMenu() {
            const navLinks = document.querySelector('.top-nav-links');
            if (navLinks) {
                navLinks.style.display = navLinks.style.display === 'flex' ? 'none' : 'flex';
            }
        }

        function escapeHtml(value) {
            if (typeof value !== 'string') {
                return '';
            }
            return value
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function formatMessageContent(value) {
            return escapeHtml(value || '').replace(/\n/g, '<br>');
        }

        function formatDateTime(value) {
            return value ? new Date(value).toLocaleString() : '';
        }

        function renderTickets() {
            const visibleTickets = showOpenOnly
                ? allTickets.filter(t => (t.status || 'open') === 'open')
                : allTickets;

            if (visibleTickets.length === 0) {
                ticketsContainer.innerHTML = '';
                ticketsEmpty.classList.remove('hidden');
                lucide.createIcons();
                return;
            }

            ticketsEmpty.classList.add('hidden');

            ticketsContainer.innerHTML = visibleTickets.map(ticket => {
                const status = (ticket.status || 'open');
                const priority = (ticket.priority || 'normal');
                const created = formatDateTime(ticket.created_at);
                const resolved = ticket.resolved_at ? formatDateTime(ticket.resolved_at) : null;
                const conversationId = `ticket-thread-${ticket.id}`;
                const formId = `support-reply-${ticket.id}`;

                const statusOptions = [
                    { value: 'open', label: 'Open' },
                    { value: 'in_progress', label: 'In Progress' },
                    { value: 'resolved', label: 'Resolved' }
                ];

                const priorityBadge = priority === 'high'
                    ? '<span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-rose-100 text-rose-600 uppercase">High Priority</span>'
                    : '<span class="px-2.5 py-1 rounded-full text-xs font-semibold bg-sky-100 text-sky-600 uppercase">Normal Priority</span>';

                const statusBadges = {
                    open: '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-gray-200 text-gray-700">Open</span>',
                    in_progress: '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-amber-100 text-amber-700">In Progress</span>',
                    resolved: '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">Resolved</span>'
                };

                const statusGuidance = status === 'resolved'
                    ? 'Ticket is resolved. Sending another update will keep the user informed.'
                    : 'Users are notified immediately when you reply.';

                return `
                    <article class="border border-slate-200/80 rounded-2xl p-6 lg:p-7 bg-white/95 backdrop-blur hover:shadow-xl hover:-translate-y-0.5 transition-all" data-ticket-id="${ticket.id}">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <div class="flex flex-wrap items-center gap-3">
                                    <h4 class="text-xl font-semibold text-slate-900">${escapeHtml(ticket.subject)}</h4>
                                    ${priorityBadge}
                                    ${statusBadges[status] || ''}
                                </div>
                                <p class="text-xs text-slate-400 mt-1">Ticket #${ticket.id} • Created ${created}</p>
                                <p class="text-sm text-slate-500 mt-1">From ${escapeHtml(ticket.user_name || 'Unknown')} (${escapeHtml(ticket.user_email || 'no email')})</p>
                                ${resolved ? `<p class="text-xs text-gray-400 mt-2">Resolved at ${resolved}</p>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="soft-button text-xs font-semibold border border-slate-200 text-slate-600 bg-white hover:bg-slate-50" onclick="copyTicketDetails(${ticket.id})">
                                    <i data-lucide="clipboard" class="w-3.5 h-3.5 inline mr-1"></i>
                                    Copy details
                                </button>
                            </div>
                        </div>

                        <div id="${conversationId}" class="mt-5 bg-slate-50/80 border border-slate-200/80 rounded-2xl p-5 space-y-3 text-sm text-slate-600 shadow-inner">
                            <p class="text-center text-slate-400 text-sm">Loading conversation...</p>
                        </div>

                        <form id="${formId}" class="mt-6 space-y-5 support-reply-form" data-ticket-id="${ticket.id}">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-[0.2em] mb-2">Status</label>
                                    <select name="status" class="w-full px-3 py-3 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white">
                                        ${statusOptions.map(option => `<option value="${option.value}" ${option.value === status ? 'selected' : ''}>${option.label}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-semibold text-slate-500 uppercase tracking-[0.2em] mb-2">Message to user</label>
                                    <textarea name="adminResponse" rows="3" class="w-full px-4 py-3 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white" placeholder="Share an update or ask for more details..."></textarea>
                                </div>
                            </div>
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <p class="text-xs text-slate-400">${statusGuidance}</p>
                                <button type="submit" class="reply-submit-btn soft-button px-6 bg-gradient-to-r from-teal-500 to-emerald-500 text-white border-none">
                                    <i data-lucide="send" class="w-4 h-4 inline mr-2"></i>
                                    Update Ticket
                                </button>
                            </div>
                        </form>
                    </article>
                `;
            }).join('');

            lucide.createIcons();

            visibleTickets.forEach(ticket => {
                loadTicketMessages(ticket.id);
                const form = document.getElementById(`support-reply-${ticket.id}`);
                if (form) {
                    form.addEventListener('submit', handleAdminReply);
                }
            });
        }

        function renderAdminMessageBubble(message) {
            const isAdmin = message.sender_role === 'admin';
            const icon = isAdmin ? 'shield' : 'user';
            const label = isAdmin ? (message.sender_name || 'Admin') : (message.sender_name || 'User');
            const timestamp = formatDateTime(message.created_at);
            const bubbleClasses = isAdmin
                ? 'bg-teal-500 text-white'
                : 'bg-white text-slate-700 border border-slate-200';

            return `
                <div class="flex ${isAdmin ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-2xl rounded-2xl px-4 py-3 shadow-sm ${bubbleClasses}">
                        <div class="flex items-center gap-2 text-xs ${isAdmin ? 'text-teal-100/90' : 'text-slate-400'} mb-2">
                            <i data-lucide="${icon}" class="w-3.5 h-3.5"></i>
                            <span class="font-semibold">${escapeHtml(label)}</span>
                            <span>• ${timestamp}</span>
                        </div>
                        <p class="leading-relaxed text-sm whitespace-pre-wrap">${formatMessageContent(message.message)}</p>
                    </div>
                </div>
            `;
        }

        async function loadTicketMessages(ticketId) {
            const container = document.getElementById(`ticket-thread-${ticketId}`);
            if (!container) {
                return;
            }

            container.innerHTML = '<p class="text-center text-slate-400 text-sm">Loading conversation...</p>';

            try {
                const response = await api.getSupportTicketMessages(ticketId);
                const messages = response.data || [];
                if (messages.length === 0) {
                    container.innerHTML = '<p class="text-center text-slate-400 text-sm">No messages yet.</p>';
                } else {
                    container.innerHTML = messages.map(renderAdminMessageBubble).join('');
                }
                lucide.createIcons();
            } catch (error) {
                console.error('Failed to load ticket messages:', error);
                container.innerHTML = '<p class="text-center text-rose-500 text-sm">Unable to load messages.</p>';
            }
        }

        async function handleAdminReply(event) {
            event.preventDefault();

            const form = event.currentTarget;
            const ticketId = form.getAttribute('data-ticket-id');
            const status = form.querySelector('select[name="status"]').value;
            const textarea = form.querySelector('textarea[name="adminResponse"]');
            const message = textarea.value.trim();
            const submitButton = form.querySelector('.reply-submit-btn');

            submitButton.disabled = true;
            submitButton.classList.add('opacity-70');

            try {
                if (message) {
                    await api.replySupportTicket(ticketId, { message, status });
                    Swal.fire('Reply sent', 'The user has been notified of your update.', 'success');
                } else {
                    await api.updateSupportTicketStatus(ticketId, { status });
                    Swal.fire('Status updated', 'Ticket status updated without sending a message.', 'success');
                }

                textarea.value = '';
                await loadTickets();
            } catch (error) {
                console.error('Failed to update ticket:', error);
                Swal.fire('Error', error.message || 'Unable to update ticket', 'error');
            } finally {
                if (document.body.contains(submitButton)) {
                    submitButton.disabled = false;
                    submitButton.classList.remove('opacity-70');
                }
            }
        }

        async function loadTickets() {
            try {
                refreshBtn.disabled = true;
                refreshBtn.classList.add('opacity-60');
                const response = await api.getAllSupportTickets();
                allTickets = response.data || [];
                renderTickets();
            } catch (error) {
                console.error('Failed to load tickets:', error);
                Swal.fire('Error', error.message || 'Unable to load support tickets', 'error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.classList.remove('opacity-60');
            }
        }

        function setFilter(openOnly) {
            showOpenOnly = openOnly;
            filterOpenBtn.classList.toggle('bg-teal-50', openOnly);
            filterOpenBtn.classList.toggle('text-teal-700', openOnly);
            filterOpenBtn.classList.toggle('border-teal-200', openOnly);

            filterAllBtn.classList.toggle('bg-gray-100', !openOnly);
            filterAllBtn.classList.toggle('text-gray-700', !openOnly);
            filterAllBtn.classList.toggle('border-gray-200', !openOnly);
            renderTickets();
        }

        filterOpenBtn.addEventListener('click', () => setFilter(true));
        filterAllBtn.addEventListener('click', () => setFilter(false));
        refreshBtn.addEventListener('click', loadTickets);

        async function copyTicketDetails(ticketId) {
            const ticket = allTickets.find(t => t.id === ticketId);
            if (!ticket) {
                return;
            }
            const details = `Ticket #${ticket.id}\nSubject: ${ticket.subject}\nPriority: ${ticket.priority}\nStatus: ${ticket.status}\nUser: ${ticket.user_name} (${ticket.user_email})\nMessage:\n${ticket.message}\n\nAdmin response:\n${ticket.admin_response || '—'}`;
            try {
                await navigator.clipboard.writeText(details);
                Swal.fire('Copied', 'Ticket details copied to clipboard', 'success');
            } catch (error) {
                console.error('Failed to copy ticket details:', error);
            }
        }

        window.copyTicketDetails = copyTicketDetails;

        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await loadTickets();
        });
    </script>
</body>
</html>
