<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Management - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; }

        /* Admin Navigation Tabs */
        .admin-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .admin-tab {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .admin-tab:hover {
            background-color: #f0fdfa;
        }

        .admin-tab.active {
            background-color: #0d9488;
            color: white;
        }

        /* Responsive Navigation */
        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
            }
            
            .admin-tab {
                width: 100%;
                justify-content: flex-start;
            }

            .top-nav-links {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i data-lucide="shield" class="w-7 h-7 text-yellow-500"></i>
                    <span class="text-xl font-bold text-gray-800">RentMate Admin</span>
                </div>
                <div class="flex items-center space-x-6 top-nav-links">
                    <a href="/index.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="home" class="w-4 h-4 inline mr-1"></i>
                        Home
                    </a>
                    <a href="/dashboard.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-1"></i>
                        Dashboard
                    </a>
                    <button onclick="handleLogout()" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                        Logout
                    </button>
                </div>
                <button class="mobile-menu-btn text-gray-700" onclick="toggleMobileMenu()">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Admin Tabs -->
        <div class="bg-white rounded-lg shadow mb-8 p-4">
            <div class="admin-tabs">
                <button onclick="window.location.href='/admin.html'" class="admin-tab">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span>Users</span>
                </button>
                <button onclick="window.location.href='/admin/items.html'" class="admin-tab">
                    <i data-lucide="package" class="w-4 h-4"></i>
                    <span>Items</span>
                </button>
                <button onclick="window.location.href='/admin/rentals.html'" class="admin-tab">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Rentals</span>
                </button>
                <button onclick="window.location.href='/admin/rental_management.html'" class="admin-tab active">
                    <i data-lucide="workflow" class="w-4 h-4"></i>
                    <span>Rental Workflow</span>
                </button>
                <button onclick="window.location.href='/admin/verification.html'" class="admin-tab">
                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                    <span>Verifications</span>
                </button>
                <button onclick="window.location.href='/admin/item_approval.html'" class="admin-tab">
                    <i data-lucide="package-check" class="w-4 h-4"></i>
                    <span>Item Approvals</span>
                </button>
                <button onclick="window.location.href='/admin/banking.html'" class="admin-tab">
                    <i data-lucide="credit-card" class="w-4 h-4"></i>
                    <span>Banking</span>
                </button>
                <button onclick="window.location.href='/admin/statistics.html'" class="admin-tab">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                    <span>Statistics</span>
                </button>
                <button onclick="window.location.href='/admin/support.html'" class="admin-tab">
                    <i data-lucide="life-buoy" class="w-4 h-4"></i>
                    <span>Customer Support</span>
                </button>
            </div>
        </div>

    <div class="min-h-screen">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Rental Workflow Management</h1>
                <p class="text-gray-600">Approve payments, track progress, and manage rentals</p>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow mb-6">
                <div class="border-b">
                    <nav class="flex -mb-px">
                        <button onclick="switchTab('pending')" class="tab-btn px-6 py-4 font-medium text-primary-600 border-b-2 border-primary-600" data-tab="pending">
                            Pending Payment Approval
                            <span class="ml-2 bg-primary-100 text-primary-800 px-2 py-1 rounded-full text-xs" id="pendingCount">0</span>
                        </button>
                        <button onclick="switchTab('active')" class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-gray-900" data-tab="active">
                            Active Rentals
                            <span class="ml-2 bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs" id="activeCount">0</span>
                        </button>
                        <button onclick="switchTab('return')" class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-gray-900" data-tab="return">
                            Pending Return Confirmation
                            <span class="ml-2 bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs" id="returnCount">0</span>
                        </button>
                        <button onclick="switchTab('completed')" class="tab-btn px-6 py-4 font-medium text-gray-600 hover:text-gray-900" data-tab="completed">
                            Completed
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Pending Payment Approval -->
            <div id="pendingTab" class="tab-content">
                <div id="pendingRentals" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Active Rentals -->
            <div id="activeTab" class="tab-content hidden">
                <div id="activeRentals" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Pending Return -->
            <div id="returnTab" class="tab-content hidden">
                <div id="returnRentals" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- Completed -->
            <div id="completedTab" class="tab-content hidden">
                <div id="completedRentals" class="space-y-4">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script>
        let allRentals = [];
        const DEPOSIT_RATE = 0.2;

        // Calculate 20% deposit for a rental
        function calculateDeposit(rental) {
            const total = parseFloat((rental && rental.total_price) || 0);
            return Number.isNaN(total) ? 0 : total * DEPOSIT_RATE;
        }

        function formatCurrency(amount) {
            const value = parseFloat(amount || 0);
            return `฿${Number.isNaN(value) ? '0.00' : value.toFixed(2)}`;
        }

        function getActiveWorkflowStatus(rental) {
            switch (rental.workflow_status) {
                case 'approved':
                    return '<span class="text-amber-600 font-semibold">Waiting for lender confirmation</span>';
                case 'lender_confirmed':
                    return '<span class="text-blue-600 font-semibold">Lender confirmed handover</span>';
                case 'active':
                    return '<span class="text-green-600 font-semibold">Rental in progress</span>';
                case 'borrower_returned':
                    return '<span class="text-purple-600 font-semibold">Borrower returned item</span>';
                default:
                    return '<span class="text-gray-600 font-semibold">In progress</span>';
            }
        }

        async function loadRentals() {
            try {
                const response = await api.getAllRentals();
                if (response.success) {
                    allRentals = response.data;
                    console.log('All rentals loaded:', allRentals);
                    console.log('Rentals with payment_slip:', allRentals.filter(r => r.payment_slip));
                    
                    // Debug: Show workflow_status for rentals with payment slip
                    allRentals.filter(r => r.payment_slip).forEach(rental => {
                        console.log(`Rental ${rental.id} - workflow_status: "${rental.workflow_status}", payment_status: "${rental.payment_status}"`);
                    });
                    
                    // Debug: Show ALL fields for one rental to check column names
                    if (allRentals.length > 0) {
                        console.log('Sample rental fields:', Object.keys(allRentals[0]));
                        console.log('Full rental data sample:', allRentals[0]);
                    }
                    
                    displayRentals();
                }
            } catch (error) {
                console.error('Error loading rentals:', error);
                Swal.fire('Error', 'Failed to load rentals', 'error');
            }
        }

        function displayRentals() {
            // Show all workflow statuses for debugging
            const workflowStatuses = [...new Set(allRentals.map(r => r.workflow_status))];
            console.log('All workflow statuses in database:', workflowStatuses);
            
            // Filter for pending payments - Show ALL rentals with pending or payment_made status, but exclude rejected
            const pending = allRentals.filter(r => {
                // Exclude rejected rentals
                if (r.workflow_status === 'rejected' || r.status === 'rejected') {
                    return false;
                }
                
                // Primary criteria: workflow_status is 'pending' or 'payment_made'
                const isPendingWorkflow = r.workflow_status === 'pending' || 
                                          r.workflow_status === 'payment_pending' ||
                                          r.workflow_status === 'payment_made' ||
                                          r.workflow_status === 'pending_payment';
                
                // Secondary criteria: payment exists but not yet approved
                const hasUnApprovedPayment = r.payment_slip && 
                                             (r.payment_status === 'pending' || !r.payment_status);
                
                return isPendingWorkflow || hasUnApprovedPayment;
            });
            
            // Active rentals include approved, lender_confirmed, active, and borrower_returned statuses
            const active = allRentals.filter(r => 
                r.workflow_status === 'approved' || 
                r.workflow_status === 'lender_confirmed' || 
                r.workflow_status === 'active' ||
                r.workflow_status === 'borrower_returned'
            );
            
            // Return pending is only for return_completed status (both parties confirmed)
            const returnPending = allRentals.filter(r => r.workflow_status === 'return_completed');
            const completed = allRentals.filter(r => r.workflow_status === 'completed');

            console.log('Pending payments:', pending);
            console.log('Active rentals:', active);
            console.log('Return pending (final payments):', returnPending);
            console.log('Completed:', completed);

            document.getElementById('pendingCount').textContent = pending.length;
            document.getElementById('activeCount').textContent = active.length;
            document.getElementById('returnCount').textContent = returnPending.length;

            displayPendingRentals(pending);
            displayActiveRentals(active);
            displayReturnRentals(returnPending);
            displayCompletedRentals(completed);
        }

        function displayPendingRentals(rentals) {
            const container = document.getElementById('pendingRentals');
            
            if (rentals.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">No pending payment approvals</div>';
                return;
            }

            container.innerHTML = rentals.map(rental => `
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex flex-col md:flex-row gap-6 mb-4">
                        <!-- Payment Details -->
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-900 mb-3">${rental.itemName}</h3>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><strong>Borrower:</strong> ${rental.borrowerName} (${rental.borrowerEmail})</p>
                                <p><strong>Lender:</strong> ${rental.lenderName} (${rental.lenderEmail})</p>
                                <p><strong>Dates:</strong> ${new Date(rental.start_date).toLocaleDateString()} - ${new Date(rental.end_date).toLocaleDateString()}</p>
                                <p><strong>Amount:</strong> ${formatCurrency(rental.total_price)}</p>
                                <p><strong>Deposit:</strong> ${formatCurrency(calculateDeposit(rental))}</p>
                                <p><strong>Payment Method:</strong> <span class="px-2 py-1 bg-teal-100 text-teal-800 rounded text-xs font-semibold">${rental.payment_method || 'Bank Transfer'}</span></p>
                                <p><strong>Payment Date:</strong> ${rental.payment_date ? new Date(rental.payment_date).toLocaleString() : 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Borrower's Payment Slip Preview -->
                        ${rental.payment_slip ? `
                            <div class="w-full md:w-64 flex-shrink-0">
                                <div class="bg-gradient-to-br from-teal-50 to-blue-50 rounded-lg p-3 border-2 border-teal-200 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i data-lucide="receipt" class="w-4 h-4 text-teal-600"></i>
                                        <span class="font-bold text-sm text-gray-900">Borrower's Payment Slip</span>
                                    </div>
                                    <img src="${rental.payment_slip}" alt="Borrower Payment Slip" class="w-full h-48 object-cover rounded border-2 border-teal-300 cursor-pointer hover:opacity-80 hover:scale-105 transition-all shadow-md" onclick="viewPaymentSlip('${rental.payment_slip.replace(/'/g, "\\'")}')">
                                    <button onclick="viewPaymentSlip('${rental.payment_slip.replace(/'/g, "\\'")}'})" class="mt-2 w-full text-center text-xs text-teal-700 hover:text-teal-800 font-bold bg-white rounded py-1.5 hover:bg-teal-50 transition">
                                        <i data-lucide="maximize-2" class="w-3 h-3 inline mr-1"></i>
                                        View Full Size
                                    </button>
                                </div>
                            </div>
                        ` : `
                            <div class="w-full md:w-64 flex-shrink-0">
                                <div class="bg-yellow-50 rounded-lg p-4 border-2 border-yellow-300 text-center shadow-sm">
                                    <i data-lucide="alert-triangle" class="w-8 h-8 text-yellow-600 mx-auto mb-2"></i>
                                    <p class="text-sm text-yellow-800 font-bold">No Payment Slip Uploaded</p>
                                    <p class="text-xs text-yellow-700 mt-1">Waiting for borrower to submit payment proof</p>
                                </div>
                            </div>
                        `}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-2 pt-4 border-t">
                        <button onclick="viewProgress(${rental.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i data-lucide="eye" class="w-4 h-4 inline mr-1"></i>
                            View Progress
                        </button>
                        <button onclick="approvePayment(${rental.id})" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <i data-lucide="check" class="w-4 h-4 inline mr-1"></i>
                            Approve Payment
                        </button>
                        <button onclick="rejectPayment(${rental.id})" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            <i data-lucide="x" class="w-4 h-4 inline mr-1"></i>
                            Reject
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        // View payment slip in full size
        function viewPaymentSlip(imageUrl) {
            Swal.fire({
                imageUrl: imageUrl,
                imageAlt: 'Payment Slip',
                title: 'Payment Slip',
                width: 800,
                showCloseButton: true,
                showConfirmButton: false,
                customClass: {
                    image: 'max-h-[70vh] object-contain'
                }
            });
        }

        // View QR Code function
        function viewQRCode(qrCodeUrl, title) {
            Swal.fire({
                imageUrl: qrCodeUrl,
                imageAlt: title || 'QR Code',
                title: title || 'QR Code',
                width: 600,
                showCloseButton: true,
                showConfirmButton: false,
                customClass: {
                    image: 'max-h-[70vh] object-contain bg-white p-4'
                }
            });
        }

        // View Return Photo function
        function viewReturnPhoto(photoUrl, itemName) {
            Swal.fire({
                title: `Return Photo - ${itemName}`,
                html: `
                    <div class="space-y-3">
                        <p class="text-sm text-gray-600">Photo of item upon return to lender</p>
                        <div class="border rounded-lg overflow-hidden">
                            <img src="${photoUrl}" alt="Return Photo" class="w-full h-auto">
                        </div>
                    </div>
                `,
                width: '700px',
                showCloseButton: true,
                confirmButtonText: 'Close',
                confirmButtonColor: '#3b82f6'
            });
        }

        // Reject payment function
        async function rejectPayment(rentalId) {
            const result = await Swal.fire({
                title: 'Reject Rental Request?',
                html: `
                    <div class="text-left space-y-4">
                        <div>
                            <label for="rejectReason" class="block text-sm font-semibold text-gray-700 mb-2">Reason for rejection</label>
                            <textarea id="rejectReason" class="w-full border border-gray-300 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-red-400" rows="3" placeholder="Enter rejection reason..." required></textarea>
                            <p class="text-xs text-gray-500 mt-1">Borrower will see this explanation in their notifications.</p>
                        </div>
                        <div>
                            <label for="rejectRefundSlip" class="block text-sm font-semibold text-gray-700 mb-2">Refund Payment Slip (Required)</label>
                            <input type="file" id="rejectRefundSlip" accept="image/*" class="block w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-md file:border-0
                                file:text-sm file:font-semibold
                                file:bg-red-50 file:text-red-700
                                hover:file:bg-red-100" required />
                            <p class="text-xs text-gray-500 mt-2">Upload proof that the user's payment was refunded. JPG or PNG only, max 10MB.</p>
                            <div id="rejectRefundPreview" class="mt-3 hidden">
                                <img id="rejectRefundImg" class="w-full rounded-lg border border-gray-200" alt="Refund slip preview" />
                            </div>
                        </div>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Reject Request',
                confirmButtonColor: '#ef4444',
                cancelButtonText: 'Cancel',
                width: '650px',
                didOpen: () => {
                    const fileInput = document.getElementById('rejectRefundSlip');
                    const preview = document.getElementById('rejectRefundPreview');
                    const previewImg = document.getElementById('rejectRefundImg');

                    fileInput?.addEventListener('change', (event) => {
                        const file = event.target.files?.[0];
                        if (!file) {
                            preview.classList.add('hidden');
                            previewImg.src = '';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            previewImg.src = e.target?.result || '';
                            preview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(file);
                    });
                },
                preConfirm: async () => {
                    const reasonInput = document.getElementById('rejectReason');
                    const fileInput = document.getElementById('rejectRefundSlip');
                    const reasonValue = reasonInput?.value.trim();
                    const file = fileInput?.files?.[0];

                    if (!reasonValue) {
                        Swal.showValidationMessage('Please provide a reason for rejection');
                        return false;
                    }

                    if (!file) {
                        Swal.showValidationMessage('Please upload a refund payment slip image');
                        return false;
                    }

                    if (!file.type.startsWith('image/')) {
                        Swal.showValidationMessage('Refund slip must be an image file');
                        return false;
                    }

                    const maxSize = 10 * 1024 * 1024; // 10MB limit
                    if (file.size > maxSize) {
                        Swal.showValidationMessage('Refund slip image must be smaller than 10MB');
                        return false;
                    }

                    const refundSlipBase64 = await fileToBase64(file);
                    return { reason: reasonValue, refundSlipBase64 };
                }
            });

            if (result.isConfirmed && result.value) {
                try {
                    const response = await api.request(`/rentals/${rentalId}/reject`, {
                        method: 'POST',
                        body: JSON.stringify({ 
                            reason: result.value.reason,
                            refund_slip: result.value.refundSlipBase64
                        })
                    });

                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Request Rejected',
                            text: 'The borrower and lender have been notified with the refund slip attached',
                            confirmButtonColor: '#0d9488'
                        });
                        await loadRentals();
                    } else {
                        throw new Error(response.message);
                    }
                } catch (error) {
                    console.error('Reject error:', error);
                    Swal.fire('Error', error.message || 'Failed to reject request', 'error');
                }
            }
        }

        function displayActiveRentals(rentals) {
            const container = document.getElementById('activeRentals');
            
            if (rentals.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">No active rentals</div>';
                return;
            }

            // Debug: Log rental data to check lender bank info
            console.log('Active rentals data:', rentals);
            rentals.forEach(rental => {
                console.log(`Rental ${rental.id} - Lender: ${rental.lenderName}`);
                console.log(`  Lender ID: ${rental.lender_id}`);
                console.log(`  Bank Name: ${rental.lenderBankName}`);
                console.log(`  Bank Number: ${rental.lenderBankNumber}`);
                console.log(`  Account Name: ${rental.lenderBankAccName}`);
                console.log(`  QR Code exists: ${rental.lenderQrCode ? 'Yes' : 'No'}`);
                console.log(`  Full rental:`, rental);
            });

            container.innerHTML = rentals.map(rental => `
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex flex-col md:flex-row gap-6 mb-4">
                        <!-- Rental Details -->
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-900 mb-3">${rental.itemName}</h3>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><strong>Borrower:</strong> ${rental.borrowerName} (${rental.borrowerEmail})</p>
                                <p><strong>Lender:</strong> ${rental.lenderName} (${rental.lenderEmail})</p>
                                <p><strong>Dates:</strong> ${new Date(rental.start_date).toLocaleDateString()} - ${new Date(rental.end_date).toLocaleDateString()}</p>
                                <p><strong>Status:</strong> ${getActiveWorkflowStatus(rental)}</p>
                                <p><strong>Amount:</strong> ${formatCurrency(rental.total_price)}</p>
                                <p><strong>Deposit:</strong> ${formatCurrency(calculateDeposit(rental))}</p>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-col gap-2 pt-4 border-t">
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="viewProgress(${rental.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i data-lucide="eye" class="w-4 h-4 inline mr-1"></i>
                            Track Progress
                        </button>
                        </div>
                        ${rental.workflow_status === 'approved' ? `
                            <p class="text-sm text-amber-600 font-semibold">Waiting for lender confirmation</p>
                        ` : ''}
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function displayReturnRentals(rentals) {
            const container = document.getElementById('returnRentals');
            
            // Filter for return_completed status only
            const returnCompleted = rentals.filter(r => r.workflow_status === 'return_completed');
            
            if (returnCompleted.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">No pending final payments</div>';
                return;
            }

            container.innerHTML = returnCompleted.map(rental => `
                <div class="bg-white rounded-xl shadow p-6">
                    <!-- Top Section: Item Details -->
                    <div class="flex items-start gap-4 mb-6">
                        <!-- Item Image -->
                        <div class="flex-shrink-0">
                            <img src="${rental.images ? JSON.parse(rental.images)[0] : '/assets/images/placeholder.jpg'}" 
                                 alt="${rental.itemName}" 
                                 class="w-24 h-24 object-cover rounded-lg border-2 border-gray-200">
                        </div>
                        
                        <!-- Details -->
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-900 mb-2">${rental.itemName}</h3>
                            <div class="text-sm text-gray-600 space-y-1">
                                <p><strong>Borrower:</strong> ${rental.borrowerName} (${rental.borrowerEmail})</p>
                                <p><strong>Lender:</strong> ${rental.lenderName} (${rental.lenderEmail})</p>
                                <p><strong>Dates:</strong> ${new Date(rental.start_date).toLocaleDateString()} - ${new Date(rental.end_date).toLocaleDateString()}</p>
                                <p><strong>Deposit Amount:</strong> ${formatCurrency(calculateDeposit(rental))}</p>
                                <p><strong>Return Confirmed:</strong> ${rental.item_returned_at ? new Date(rental.item_returned_at).toLocaleString() : 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Middle Section: Three Columns - Borrower Return Photo, Lender Return Photo & Borrower QR Code -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <!-- Left Column: Borrower's Return Photo -->
                        <div>
                            ${rental.borrower_return_photo ? `
                                <div class="bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg p-3 border-2 border-orange-200 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i data-lucide="camera" class="w-4 h-4 text-orange-600"></i>
                                        <span class="font-bold text-xs text-gray-900">Borrower's Return Photo</span>
                                    </div>
                                    <div class="flex justify-center">
                                        <img src="${rental.borrower_return_photo}" 
                                             alt="Borrower Return Photo" 
                                             class="w-32 h-32 object-cover rounded border-2 border-orange-300 cursor-pointer hover:opacity-80 hover:scale-105 transition-all shadow-md" 
                                             onclick="viewReturnPhoto('${rental.borrower_return_photo.replace(/'/g, "\\'")}', 'Borrower - ${rental.itemName.replace(/'/g, "\\'")}')">
                                    </div>
                                    <button onclick="viewReturnPhoto('${rental.borrower_return_photo.replace(/'/g, "\\'")}', 'Borrower - ${rental.itemName.replace(/'/g, "\\'")}'})" 
                                            class="mt-2 w-full text-center text-xs text-orange-700 hover:text-orange-800 font-bold bg-white rounded py-1 hover:bg-orange-50 transition">
                                        <i data-lucide="maximize-2" class="w-3 h-3 inline mr-1"></i>
                                        View Full Size
                                    </button>
                                </div>
                            ` : `
                                <div class="bg-gray-100 rounded-lg p-3 border-2 border-gray-300 text-center shadow-sm">
                                    <i data-lucide="image-off" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                    <p class="text-xs text-gray-600 font-semibold">No Photo</p>
                                    <p class="text-xs text-gray-500">Borrower didn't upload</p>
                                </div>
                            `}
                        </div>
                        
                        <!-- Middle Column: Lender's Return Photo -->
                        <div>
                            ${rental.lender_return_photo ? `
                                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border-2 border-blue-200 shadow-sm">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i data-lucide="camera" class="w-4 h-4 text-blue-600"></i>
                                        <span class="font-bold text-xs text-gray-900">Lender's Return Photo</span>
                                    </div>
                                    <div class="flex justify-center">
                                        <img src="${rental.lender_return_photo}" 
                                             alt="Lender Return Photo" 
                                             class="w-32 h-32 object-cover rounded border-2 border-blue-300 cursor-pointer hover:opacity-80 hover:scale-105 transition-all shadow-md" 
                                             onclick="viewReturnPhoto('${rental.lender_return_photo.replace(/'/g, "\\'")}', 'Lender - ${rental.itemName.replace(/'/g, "\\'")}')">
                                    </div>
                                    <button onclick="viewReturnPhoto('${rental.lender_return_photo.replace(/'/g, "\\'")}', 'Lender - ${rental.itemName.replace(/'/g, "\\'")}'})" 
                                            class="mt-2 w-full text-center text-xs text-blue-700 hover:text-blue-800 font-bold bg-white rounded py-1 hover:bg-blue-50 transition">
                                        <i data-lucide="maximize-2" class="w-3 h-3 inline mr-1"></i>
                                        View Full Size
                                    </button>
                                </div>
                            ` : `
                                <div class="bg-gray-100 rounded-lg p-3 border-2 border-gray-300 text-center shadow-sm">
                                    <i data-lucide="image-off" class="w-8 h-8 text-gray-400 mx-auto mb-2"></i>
                                    <p class="text-xs text-gray-600 font-semibold">No Photo</p>
                                    <p class="text-xs text-gray-500">Lender didn't upload</p>
                                </div>
                            `}
                        </div>
                        
                        <!-- Right Column: Borrower's Bank Account QR Code -->
                        <div>
                            ${rental.borrowerQrCode ? `
                                <div class="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-lg p-3 border-2 border-teal-200 shadow-sm h-full">
                                    <div class="flex items-center gap-2 mb-2">
                                        <i data-lucide="smartphone" class="w-4 h-4 text-teal-600"></i>
                                        <span class="font-bold text-xs text-gray-900">Borrower Bank Account</span>
                                    </div>
                                    <div class="bg-white rounded-lg p-2 mb-2">
                                        <p class="text-xs text-gray-700"><strong>Bank:</strong> ${rental.borrowerBankName || 'N/A'}</p>
                                        <p class="text-xs text-gray-700"><strong>Account:</strong> ${rental.borrowerBankNumber || 'N/A'}</p>
                                        <p class="text-xs text-gray-700"><strong>Name:</strong> ${rental.borrowerBankAccName || 'N/A'}</p>
                                    </div>
                                    <div class="flex justify-center">
                                        <img src="${rental.borrowerQrCode}" 
                                             alt="Borrower QR Code" 
                                             class="w-32 h-32 object-contain rounded border-2 border-teal-300 bg-white cursor-pointer hover:scale-105 transition-all shadow-md" 
                                             onclick="viewQRCode('${rental.borrowerQrCode.replace(/'/g, "\\'")}', 'Borrower QR Code - ${rental.borrowerName.replace(/'/g, "\\'")}')">
                                    </div>
                                    <button onclick="viewQRCode('${rental.borrowerQrCode.replace(/'/g, "\\'")}', 'Borrower QR Code - ${rental.borrowerName.replace(/'/g, "\\'")}'})" 
                                            class="mt-2 w-full text-center text-xs text-teal-700 hover:text-teal-800 font-bold bg-white rounded py-1 hover:bg-teal-50 transition">
                                        <i data-lucide="maximize-2" class="w-3 h-3 inline mr-1"></i>
                                        View Full Size
                                    </button>
                                    <p class="text-xs text-teal-700 mt-2 text-center italic">Scan to refund deposit</p>
                                </div>
                            ` : `
                                <div class="bg-yellow-50 rounded-lg p-3 border-2 border-yellow-300 text-center shadow-sm h-full flex flex-col justify-center">
                                    <i data-lucide="alert-circle" class="w-6 h-6 text-yellow-600 mx-auto mb-2"></i>
                                    <p class="text-xs text-yellow-800 font-bold mb-1">No Bank Account</p>
                                    <p class="text-xs text-yellow-700 mb-2">Borrower hasn't added bank details</p>
                                    <button onclick="notifyBorrowerToAddBank(${rental.borrower_id}, '${rental.borrowerEmail}')" 
                                            class="w-full px-2 py-1.5 bg-yellow-600 text-white text-xs font-semibold rounded-lg hover:bg-yellow-700 transition">
                                        <i data-lucide="bell" class="w-3 h-3 inline mr-1"></i>
                                        Notify Borrower
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-2 pt-4 border-t">
                        <button onclick="viewProgress(${rental.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i data-lucide="eye" class="w-4 h-4 inline mr-1"></i>
                            View Progress
                        </button>
                        <button onclick='processFinalPayments(${JSON.stringify(rental).replace(/'/g, "&#39;")})' class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                            <i data-lucide="dollar-sign" class="w-4 h-4 inline mr-1"></i>
                            Process Final Payments
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function displayCompletedRentals(rentals) {
            const container = document.getElementById('completedRentals');
            
            if (rentals.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">No completed rentals</div>';
                return;
            }

            container.innerHTML = rentals.map(rental => `
                <div class="bg-white rounded-xl shadow p-6">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-gray-900">${rental.itemName}</h3>
                            <div class="text-sm text-gray-600 mt-2 space-y-1">
                                <p><strong>Borrower:</strong> ${rental.borrowerName}</p>
                                <p><strong>Lender:</strong> ${rental.lenderName}</p>
                                <p><strong>Deposit:</strong> ${formatCurrency(calculateDeposit(rental))}</p>
                                <p><strong>Completed:</strong> ${rental.deposit_refunded_at ? new Date(rental.deposit_refunded_at).toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                        <button onclick="viewProgress(${rental.id})" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i data-lucide="history" class="w-4 h-4 inline mr-1"></i>
                            View History
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function switchTab(tabName) {
            // Update button styles
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-primary-600', 'border-b-2', 'border-primary-600');
                btn.classList.add('text-gray-600');
            });
            
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.remove('text-gray-600');
            activeBtn.classList.add('text-primary-600', 'border-b-2', 'border-primary-600');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
        }

        async function approvePayment(rentalId) {
            const result = await Swal.fire({
                title: 'Approve Payment?',
                text: 'This will approve the payment and enable chat between borrower and lender',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Approve',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#10b981'
            });

            if (result.isConfirmed) {
                try {
                    const response = await api.request('/payments/approve', {
                        method: 'POST',
                        body: JSON.stringify({ rental_id: rentalId })
                    });

                    if (response.success) {
                        Swal.fire('Approved!', 'Payment approved successfully', 'success');
                        loadRentals();
                    }
                } catch (error) {
                    Swal.fire('Error', error.message || 'Failed to approve payment', 'error');
                }
            }
        }

        async function processFinalPayments(rental) {
            const rentalId = rental.id;
            const rentalTotal = parseFloat(rental.total_price || 0);
            const depositAmount = calculateDeposit(rental);
            
            const result = await Swal.fire({
                title: 'Process Final Payments',
                html: `
                    <div class="text-left space-y-4">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4">
                            <p class="text-sm text-blue-800">
                                <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                                Process both lender payment and borrower deposit refund
                            </p>
                        </div>

                        <!-- Lender Fee Section -->
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="font-bold text-gray-800 mb-3">1. Pay Lender Fee</h3>
                            ${rental.lenderBankName ? `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3">
                                    <div class="flex gap-3">
                                        <div class="flex-1">
                                            <p class="text-xs text-gray-600 mb-1 font-semibold">Lender Bank Account:</p>
                                            <p class="text-sm font-bold text-gray-900">${rental.lenderBankName}</p>
                                            <p class="text-sm text-gray-700">Account: ${rental.lenderBankNumber}</p>
                                            <p class="text-sm text-gray-700">Name: ${rental.lenderBankAccName}</p>
                                        </div>
                                        ${rental.lenderQrCode ? `
                                            <div class="flex-shrink-0">
                                                <img src="${rental.lenderQrCode}" alt="Lender QR Code" class="w-20 h-20 border border-gray-300 rounded">
                                                <p class="text-xs text-center text-gray-600 mt-1">QR Code</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : '<div class="bg-yellow-50 border border-yellow-300 rounded p-2 mb-3"><p class="text-xs text-yellow-800">⚠️ Lender has not added bank account</p></div>'}
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Lender Fee Amount (฿) <span class="text-red-500">*</span>
                                </label>
                                <input type="number" id="lenderFeeAmount" value="${Number.isNaN(rentalTotal) ? '' : rentalTotal.toFixed(2)}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter amount">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Admin Payment Slip to Lender <span class="text-red-500">*</span>
                                </label>
                                <p class="text-xs text-gray-600 mb-2">Upload proof that you transferred the fee to the lender</p>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                    <input type="file" id="lenderPaymentSlipInput" accept="image/*" class="hidden" onchange="previewLenderSlip()">
                                    <label for="lenderPaymentSlipInput" class="cursor-pointer flex flex-col items-center">
                                        <i data-lucide="upload-cloud" class="w-12 h-12 text-gray-400 mb-2"></i>
                                        <p class="text-sm font-semibold text-gray-700">Upload your payment slip</p>
                                        <p class="text-xs text-gray-500">Showing transfer to lender</p>
                                    </label>
                                </div>
                                <div id="lenderSlipPreview" class="hidden mt-2">
                                    <img id="lenderSlipImg" src="" alt="Preview" class="w-full h-32 object-cover rounded border">
                                </div>
                            </div>
                        </div>

                        <!-- Borrower Refund Section -->
                        <div class="border border-gray-300 rounded-lg p-4">
                            <h3 class="font-bold text-gray-800 mb-3">2. Refund Borrower Deposit</h3>
                            ${rental.borrowerBankName ? `
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                    <div class="flex gap-3">
                                        <div class="flex-1">
                                            <p class="text-xs text-gray-600 mb-1 font-semibold">Borrower Bank Account:</p>
                                            <p class="text-sm font-bold text-gray-900">${rental.borrowerBankName}</p>
                                            <p class="text-sm text-gray-700">Account: ${rental.borrowerBankNumber}</p>
                                            <p class="text-sm text-gray-700">Name: ${rental.borrowerBankAccName}</p>
                                        </div>
                                        ${rental.borrowerQrCode ? `
                                            <div class="flex-shrink-0">
                                                <img src="${rental.borrowerQrCode}" alt="Borrower QR Code" class="w-20 h-20 border border-gray-300 rounded">
                                                <p class="text-xs text-center text-gray-600 mt-1">QR Code</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : '<div class="bg-yellow-50 border border-yellow-300 rounded p-2 mb-3"><p class="text-xs text-yellow-800">⚠️ Borrower has not added bank account</p></div>'}
                            <p class="text-sm text-gray-600 mb-3">Deposit Amount: <strong>${formatCurrency(depositAmount)}</strong></p>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Admin Payment Slip to Borrower <span class="text-red-500">*</span>
                                </label>
                                <p class="text-xs text-gray-600 mb-2">Upload proof that you refunded the deposit to the borrower</p>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                    <input type="file" id="refundSlipInput" accept="image/*" class="hidden" onchange="previewRefundSlip()">
                                    <label for="refundSlipInput" class="cursor-pointer flex flex-col items-center">
                                        <i data-lucide="upload-cloud" class="w-12 h-12 text-gray-400 mb-2"></i>
                                        <p class="text-sm font-semibold text-gray-700">Upload your payment slip</p>
                                        <p class="text-xs text-gray-500">Showing refund to borrower</p>
                                    </label>
                                </div>
                                <div id="refundSlipPreview" class="hidden mt-2">
                                    <img id="refundSlipImg" src="" alt="Preview" class="w-full h-32 object-cover rounded border">
                                </div>
                            </div>
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Process Payments',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#10b981',
                width: '700px',
                didOpen: () => {
                    lucide.createIcons();
                },
                preConfirm: () => {
                    const lenderAmount = document.getElementById('lenderFeeAmount').value;
                    const lenderSlipInput = document.getElementById('lenderPaymentSlipInput');
                    const refundSlipInput = document.getElementById('refundSlipInput');
                    
                    if (!lenderAmount || lenderAmount <= 0) {
                        Swal.showValidationMessage('Please enter lender fee amount');
                        return false;
                    }
                    
                    if (!lenderSlipInput.files || !lenderSlipInput.files[0]) {
                        Swal.showValidationMessage('Please upload your payment slip showing transfer to lender');
                        return false;
                    }
                    
                    if (!refundSlipInput.files || !refundSlipInput.files[0]) {
                        Swal.showValidationMessage('Please upload your payment slip showing refund to borrower');
                        return false;
                    }
                    
                    return {
                        lenderAmount: parseFloat(lenderAmount),
                        lenderSlipFile: lenderSlipInput.files[0],
                        refundSlipFile: refundSlipInput.files[0]
                    };
                }
            });

            if (result.isConfirmed) {
                try {
                    Swal.fire({
                        title: 'Processing...',
                        text: 'Please wait while we process the payments',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Convert images to base64
                    const lenderSlipBase64 = await fileToBase64(result.value.lenderSlipFile);
                    const refundSlipBase64 = await fileToBase64(result.value.refundSlipFile);

                    const response = await api.request('/payments/process-final', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            rental_id: rentalId,
                            lender_fee_amount: result.value.lenderAmount,
                            lender_payment_slip: lenderSlipBase64,
                            refund_slip: refundSlipBase64
                        })
                    });

                    if (response.success) {
                        await Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Final payments processed successfully',
                            confirmButtonColor: '#10b981'
                        });
                        loadRentals();
                    }
                } catch (error) {
                    Swal.fire('Error', error.message || 'Failed to process payments', 'error');
                }
            }
        }

        // Helper function to convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        }

        // Preview functions
        window.previewLenderSlip = function() {
            const fileInput = document.getElementById('lenderPaymentSlipInput');
            const preview = document.getElementById('lenderSlipPreview');
            const img = document.getElementById('lenderSlipImg');
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        };

        // Legacy function kept for compatibility
        async function refundDeposit(rentalId) {
            // This is now handled by processFinalPayments
            Swal.fire({
                icon: 'info',
                title: 'Update Available',
                text: 'Please use the "Process Final Payments" button to handle both lender payment and deposit refund.',
                confirmButtonColor: '#0d9488'
            });
        }

        // Preview refund slip in SweetAlert
        window.previewRefundSlip = function() {
            const fileInput = document.getElementById('refundSlipInput');
            const preview = document.getElementById('refundSlipPreview');
            const img = document.getElementById('refundSlipImg');
            
            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        };

        async function viewProgress(rentalId) {
            window.location.href = `/admin/rentals.html`;
        }

        function handleLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login.html';
        }

        // Notify lender to add bank account
        async function notifyBorrowerToAddBank(borrowerId, borrowerEmail) {
            const result = await Swal.fire({
                title: 'Notify Borrower?',
                html: `Send notification to <strong>${borrowerEmail}</strong> to add their bank account details for deposit refund?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Notify',
                confirmButtonColor: '#0d9488',
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                Swal.fire({
                    icon: 'info',
                    title: 'Feature Coming Soon',
                    html: `
                        <p class="mb-3">Email notification feature will be implemented soon.</p>
                        <p class="text-sm text-gray-600">For now, please contact the borrower at:</p>
                        <p class="font-semibold text-teal-600">${borrowerEmail}</p>
                        <p class="text-sm text-gray-600 mt-2">Ask them to:</p>
                        <ol class="text-left text-sm text-gray-700 ml-6 mt-2">
                            <li>1. Go to their Profile page</li>
                            <li>2. Add Bank Account Information</li>
                            <li>3. Upload QR Code for receiving deposit refund</li>
                        </ol>
                    `,
                    confirmButtonColor: '#0d9488'
                });
            }
        }

        function toggleMobileMenu() {
            const navLinks = document.querySelector('.top-nav-links');
            if (navLinks) {
                navLinks.style.display = navLinks.style.display === 'flex' ? 'none' : 'flex';
                navLinks.style.flexDirection = 'column';
                navLinks.style.position = 'absolute';
                navLinks.style.top = '100%';
                navLinks.style.right = '0';
                navLinks.style.backgroundColor = 'white';
                navLinks.style.padding = '1rem';
                navLinks.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                navLinks.style.borderRadius = '0.5rem';
                navLinks.style.marginTop = '0.5rem';
            }
        }

        // Initialize
        lucide.createIcons();
        loadRentals();
    </script>
</body>
</html>
