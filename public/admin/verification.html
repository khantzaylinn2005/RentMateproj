<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lender Verification - RentMate Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d9488',
                        secondary: '#0f766e',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; }
        
        .verification-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .verification-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .passport-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .passport-preview:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        /* Admin Navigation Tabs */
        .admin-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .admin-tab {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .admin-tab:hover {
            background-color: #f0fdfa;
        }

        .admin-tab.active {
            background-color: #0d9488;
            color: white;
        }

        /* Responsive Navigation */
        @media (max-width: 768px) {
            .admin-tabs {
                flex-direction: column;
            }
            
            .admin-tab {
                width: 100%;
                justify-content: flex-start;
            }

            .top-nav-links {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .mobile-menu-btn {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <i data-lucide="shield" class="w-7 h-7 text-yellow-500"></i>
                    <span class="text-xl font-bold text-gray-800">RentMate Admin</span>
                </div>
                <div class="flex items-center space-x-6 top-nav-links">
                    <a href="/index.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="home" class="w-4 h-4 inline mr-1"></i>
                        Home
                    </a>
                    <a href="/dashboard.html" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="layout-dashboard" class="w-4 h-4 inline mr-1"></i>
                        Dashboard
                    </a>
                    <button onclick="logout()" class="text-gray-700 hover:text-primary transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4 inline mr-1"></i>
                        Logout
                    </button>
                </div>
                <button class="mobile-menu-btn text-gray-700" onclick="toggleMobileMenu()">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 py-8">
        <!-- Admin Tabs -->
        <div class="bg-white rounded-lg shadow mb-8 p-4">
            <div class="admin-tabs">
                <button onclick="window.location.href='/admin.html'" class="admin-tab">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    <span>Users</span>
                </button>
                <button onclick="window.location.href='/admin/items.html'" class="admin-tab">
                    <i data-lucide="package" class="w-4 h-4"></i>
                    <span>Items</span>
                </button>
                <button onclick="window.location.href='/admin/rentals.html'" class="admin-tab">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span>Rentals</span>
                </button>
                <button onclick="window.location.href='/admin/rental_management.html'" class="admin-tab">
                    <i data-lucide="workflow" class="w-4 h-4"></i>
                    <span>Rental Workflow</span>
                </button>
                <button onclick="window.location.href='/admin/verification.html'" class="admin-tab active">
                    <i data-lucide="shield-check" class="w-4 h-4"></i>
                    <span>Verifications</span>
                </button>
                <button onclick="window.location.href='/admin/item_approval.html'" class="admin-tab">
                    <i data-lucide="package-check" class="w-4 h-4"></i>
                    <span>Item Approvals</span>
                </button>
                <button onclick="window.location.href='/admin.html'" class="admin-tab">
                    <i data-lucide="bar-chart" class="w-4 h-4"></i>
                    <span>Statistics</span>
                </button>
            </div>
        </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                        <i data-lucide="shield-check" class="w-8 h-8 text-primary"></i>
                        Lender Verification Requests
                    </h1>
                    <p class="text-gray-600 mt-2">Review and approve lender verification requests</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Pending Verifications</div>
                    <div class="text-3xl font-bold text-primary" id="pendingCount">0</div>
                </div>
            </div>
        </div>

        <!-- Info Alert -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <i data-lucide="info" class="w-5 h-5 text-blue-500 mr-3 mt-0.5"></i>
                <div class="text-sm text-blue-800">
                    <p class="font-semibold mb-1">Verification Guidelines:</p>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Verify that the passport/ID document is clear and legible</li>
                        <li>Check that the passport number matches the document</li>
                        <li>Ensure the document belongs to the user</li>
                        <li>Approved users will gain access to lender features</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Verifications Grid -->
        <div id="verificationsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Verification cards will be inserted here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-16">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-gray-100 rounded-full mb-4">
                <i data-lucide="check-circle" class="w-10 h-10 text-gray-400"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-700 mb-2">No Pending Verifications</h3>
            <p class="text-gray-500">All verification requests have been processed.</p>
        </div>
    </div>

    <script src="../app.js"></script>
    <script>
        lucide.createIcons();

        // Check if admin is logged in (currentUser is already declared in app.js)
        if (!currentUser || currentUser.role !== 'admin') {
            window.location.href = '/admin.html';
        }

        let currentVerifications = [];

        // Load pending verifications
        async function loadPendingVerifications() {
            try {
                console.log('Loading pending verifications...');
                const response = await api.getPendingVerifications();
                console.log('API Response:', response);
                console.log('Verifications data:', response.data);
                currentVerifications = response.data;
                displayVerifications(currentVerifications);
                document.getElementById('pendingCount').textContent = currentVerifications.length;
            } catch (error) {
                console.error('Error loading verifications:', error);
                ui.showNotification(error.message, 'error');
            }
        }

        function displayVerifications(verifications) {
            const container = document.getElementById('verificationsContainer');
            const emptyState = document.getElementById('emptyState');
            
            console.log('Displaying verifications:', verifications);
            console.log('Number of verifications:', verifications.length);
            
            if (verifications.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                console.log('No verifications - showing empty state');
                return;
            }
            
            container.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            container.innerHTML = verifications.map((user, index) => `
                <div class="verification-card p-6">
                    <!-- User Info -->
                    <div class="mb-4 pb-4 border-b border-gray-200">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 bg-primary/10 rounded-full flex items-center justify-center">
                                <span class="text-primary font-bold text-lg">${user.name.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="flex-1">
                                <h3 class="font-bold text-gray-800 text-lg">${user.name}</h3>
                                <p class="text-sm text-gray-500">${user.email}</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-center gap-2 text-gray-600">
                                <i data-lucide="phone" class="w-4 h-4"></i>
                                <span>${user.phone}</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <i data-lucide="credit-card" class="w-4 h-4"></i>
                                <span class="font-mono">${user.passport_no || 'N/A'}</span>
                            </div>
                            <div class="flex items-center gap-2 text-gray-600">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                <span>Submitted: ${new Date(user.created_at).toLocaleDateString()}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Passport Images -->
                    <div class="mb-4">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Passport/ID Documents:</p>
                        <div id="images-container-${index}" class="grid grid-cols-2 gap-2">
                            ${user.passport_images && user.passport_images.length > 0 
                                ? user.passport_images.map((img, imgIndex) => `
                                    <div class="relative group">
                                        <img 
                                            id="passport-img-${index}-${imgIndex}"
                                            alt="Passport Document ${imgIndex + 1}" 
                                            class="passport-preview w-full h-32 object-cover cursor-pointer"
                                            style="background: #f3f4f6;"
                                            onclick="viewFullImage(${index}, ${imgIndex})"
                                            onerror="console.error('Image ${imgIndex} failed to load for user ${index}'); this.style.display='none';"
                                        >
                                        <div class="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded">
                                            ${imgIndex + 1}/${user.passport_images.length}
                                        </div>
                                    </div>
                                `).join('')
                                : `<div class="col-span-2 bg-gray-100 rounded-lg p-4 text-center text-gray-500">
                                    <i data-lucide="image-off" class="w-8 h-8 mx-auto mb-2"></i>
                                    <p class="text-sm">No documents uploaded</p>
                                </div>`
                            }
                        </div>
                        ${user.passport_images && user.passport_images.length > 0 
                            ? '<p class="text-center mt-2 text-xs text-gray-500">Click to view full size</p>' 
                            : ''}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="grid grid-cols-2 gap-3">
                        <button 
                            onclick="handleVerification(${user.id}, 'verified', ${index})" 
                            class="bg-green-500 text-white px-4 py-3 rounded-lg hover:bg-green-600 transition-colors font-semibold flex items-center justify-center gap-2">
                            <i data-lucide="check" class="w-4 h-4"></i>
                            Approve
                        </button>
                        <button 
                            onclick="handleVerification(${user.id}, 'rejected', ${index})" 
                            class="bg-red-500 text-white px-4 py-3 rounded-lg hover:bg-red-600 transition-colors font-semibold flex items-center justify-center gap-2">
                            <i data-lucide="x" class="w-4 h-4"></i>
                            Reject
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Set image sources after HTML is rendered (avoids quote escaping issues in template literals)
            console.log('About to set image sources for', verifications.length, 'verifications');
            verifications.forEach((user, index) => {
                if (user.passport_images && user.passport_images.length > 0) {
                    console.log(`User ${index} (${user.name}) has ${user.passport_images.length} passport images`);
                    user.passport_images.forEach((imgData, imgIndex) => {
                        const imgElement = document.getElementById(`passport-img-${index}-${imgIndex}`);
                        if (imgElement) {
                            console.log(`Setting image ${imgIndex} for user ${index}`);
                            imgElement.src = imgData;
                        } else {
                            console.error(`Could not find img element with id: passport-img-${index}-${imgIndex}`);
                        }
                    });
                } else {
                    console.warn(`User ${index} (${user.name}) has NO passport_images`);
                }
            });
            
            // Re-initialize Lucide icons for the new content
            lucide.createIcons();
        }

        function viewFullImage(index, imgIndex = 0) {
            const user = currentVerifications[index];
            if (user && user.passport_images && user.passport_images.length > 0) {
                const images = user.passport_images;
                const currentImage = imgIndex;
                
                Swal.fire({
                    title: `Passport/ID Document (${currentImage + 1}/${images.length})`,
                    html: `
                        <div class="space-y-3">
                            <div class="text-left bg-gray-50 p-4 rounded-lg">
                                <p class="text-sm"><strong>Name:</strong> ${user.name}</p>
                                <p class="text-sm"><strong>Email:</strong> ${user.email}</p>
                                <p class="text-sm"><strong>Passport No:</strong> ${user.passport_no || 'N/A'}</p>
                            </div>
                            <div class="relative">
                                <img id="modal-passport-img" class="w-full rounded-lg" alt="Passport Document">
                                ${images.length > 1 ? `
                                    <div class="flex justify-between mt-4 gap-2">
                                        <button id="prevBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium">
                                            ← Previous
                                        </button>
                                        <button id="nextBtn" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-medium">
                                            Next →
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `,
                    width: '800px',
                    showCloseButton: true,
                    showConfirmButton: false,
                    customClass: {
                        popup: 'rounded-2xl'
                    },
                    didOpen: () => {
                        let currentIdx = currentImage;
                        
                        // Set initial image
                        const modalImg = document.getElementById('modal-passport-img');
                        if (modalImg) {
                            modalImg.src = images[currentIdx];
                        }
                        
                        // Navigation buttons
                        if (images.length > 1) {
                            const prevBtn = document.getElementById('prevBtn');
                            const nextBtn = document.getElementById('nextBtn');
                            
                            const updateImage = () => {
                                modalImg.src = images[currentIdx];
                                Swal.getTitle().textContent = `Passport/ID Document (${currentIdx + 1}/${images.length})`;
                                
                                // Disable/enable buttons
                                prevBtn.disabled = currentIdx === 0;
                                nextBtn.disabled = currentIdx === images.length - 1;
                                
                                prevBtn.style.opacity = currentIdx === 0 ? '0.5' : '1';
                                nextBtn.style.opacity = currentIdx === images.length - 1 ? '0.5' : '1';
                            };
                            
                            prevBtn.addEventListener('click', () => {
                                if (currentIdx > 0) {
                                    currentIdx--;
                                    updateImage();
                                }
                            });
                            
                            nextBtn.addEventListener('click', () => {
                                if (currentIdx < images.length - 1) {
                                    currentIdx++;
                                    updateImage();
                                }
                            });
                            
                            updateImage();
                        }
                    }
                });
            }
        }

        async function handleVerification(userId, status, index) {
            const action = status === 'verified' ? 'approve' : 'reject';
            const user = currentVerifications[index];
            
            const result = await Swal.fire({
                title: `${action.charAt(0).toUpperCase() + action.slice(1)} Verification?`,
                html: `
                    <p class="mb-2">Are you sure you want to <strong>${action}</strong> this verification request?</p>
                    <div class="bg-gray-50 p-3 rounded-lg text-left mt-3">
                        <p class="text-sm"><strong>User:</strong> ${user.name}</p>
                        <p class="text-sm"><strong>Email:</strong> ${user.email}</p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: status === 'verified' ? '#10b981' : '#ef4444',
                cancelButtonColor: '#6b7280',
                confirmButtonText: `Yes, ${action}`,
                cancelButtonText: 'Cancel'
            });

            if (result.isConfirmed) {
                try {
                    await api.verifyLender(userId, status);
                    
                    Swal.fire({
                        icon: 'success',
                        title: `Verification ${status === 'verified' ? 'Approved' : 'Rejected'}!`,
                        text: `User has been ${status === 'verified' ? 'approved as a lender' : 'rejected'}.`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    
                    // Reload verifications
                    await loadPendingVerifications();
                } catch (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message
                    });
                }
            }
        }

        function logout() {
            localStorage.removeItem('user');
            localStorage.removeItem('token');
            window.location.href = '/admin.html';
        }

        function toggleMobileMenu() {
            const navLinks = document.querySelector('.top-nav-links');
            if (navLinks) {
                navLinks.style.display = navLinks.style.display === 'flex' ? 'none' : 'flex';
                navLinks.style.flexDirection = 'column';
                navLinks.style.position = 'absolute';
                navLinks.style.top = '100%';
                navLinks.style.right = '0';
                navLinks.style.backgroundColor = 'white';
                navLinks.style.padding = '1rem';
                navLinks.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)';
                navLinks.style.borderRadius = '0.5rem';
                navLinks.style.marginTop = '0.5rem';
            }
        }

        // Initialize page
        window.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await loadPendingVerifications();
        });
    </script>
</body>
</html>
