<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Lending - RentMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d9488',
                        secondary: '#0f766e',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; }
        
        .btn-primary {
            padding: 0.625rem 1.25rem;
            background-color: #0d9488;
            color: white;
            font-weight: 500;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            font-size: 0.875rem;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary:hover {
            background-color: #0f766e;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: linear-gradient(180deg, #0d9488 0%, #0f766e 100%);
            padding: 1.5rem 0;
            z-index: 100;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            padding: 0 1.5rem;
            margin-bottom: 1.5rem;
            color: white;
        }

        .sidebar-logo i {
            width: 32px;
            height: 32px;
        }

        .sidebar-logo span {
            font-size: 1.375rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }

        .sidebar-nav {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            padding: 0 1rem;
            margin-bottom: 1rem;
        }

        .sidebar-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.375rem;
            padding: 0.875rem 0.5rem;
            color: rgba(255, 255, 255, 0.85);
            border-radius: 0.5rem;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.8125rem;
            text-decoration: none;
            text-align: center;
        }

        .sidebar-link i {
            width: 20px;
            height: 20px;
        }

        .sidebar-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }

        .sidebar-link.active {
            background: rgba(255, 255, 255, 0.25);
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-link.lender-feature[data-locked="true"] {
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
        }

        .sidebar-link.lender-feature[data-locked="true"]:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: none;
        }

        .locked-icon {
            opacity: 0.7;
        }

        .sidebar-link.lender-feature[data-locked="false"] .locked-icon {
            display: none;
        }

        .sidebar-user {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem 1.5rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(0, 0, 0, 0.1);
        }

        .sidebar-user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
            margin-bottom: 0.75rem;
        }

        .sidebar-user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.25);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.125rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-user-menu {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .sidebar-user-menu a {
            color: rgba(255, 255, 255, 0.85);
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .sidebar-user-menu a:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(2px);
        }

        .main-content {
            margin-left: 260px;
            min-height: 100vh;
            background: #f8fafc;
        }

        .container {
            max-width: 1100px;
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <aside class="sidebar">
        <div class="sidebar-logo">
            <i data-lucide="tent" class="w-8 h-8"></i>
            <span class="text-xl font-bold">RentMate</span>
        </div>

        <nav class="sidebar-nav">
            <a href="/browse_items.html" class="sidebar-link">
                <i data-lucide="search" class="w-5 h-5"></i>
                <span>Browse Items</span>
            </a>
            <a href="/dashboard.html" class="sidebar-link">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span>Dashboard</span>
            </a>
            <a href="/list_new_item.html" class="sidebar-link">
                <i data-lucide="plus-circle" class="w-5 h-5"></i>
                <span>List New Item</span>
            </a>
            <a href="/my_items.html" class="sidebar-link">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span>My Items</span>
            </a>
            <a href="/borrowing.html" class="sidebar-link">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                <span>Borrowing</span>
            </a>
            <a href="/lending.html" class="sidebar-link active">
                <i data-lucide="truck" class="w-5 h-5"></i>
                <span>Lending</span>
            </a>
            <a href="/chat.html" class="sidebar-link">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                <span>Chat</span>
            </a>
            <a href="/notification.html" id="notificationsLink" class="sidebar-link">
                <div class="relative inline-block">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span id="notificationBadge" class="absolute -top-1 -right-1 hidden bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center"></span>
                </div>
                <span>Notifications</span>
            </a>
        </nav>

        <div class="sidebar-user">
            <div class="sidebar-user-info">
                <div class="sidebar-user-avatar" id="userAvatar">U</div>
                <div>
                    <div id="sidebarUserName" class="font-semibold text-sm">User</div>
                    <div class="text-xs text-white/70" id="userRole">Member</div>
                </div>
            </div>
            <div class="sidebar-user-menu">
                <a href="/profile.html">
                    <i data-lucide="user" class="w-4 h-4 inline mr-2"></i>
                    Profile
                </a>
                <a href="/support.html">
                    <i data-lucide="life-buoy" class="w-4 h-4 inline mr-2"></i>
                    Customer Support
                </a>
                <a href="#" onclick="handleLogout()">
                    <i data-lucide="log-out" class="w-4 h-4 inline mr-2"></i>
                    Logout
                </a>
            </div>
        </div>
    </aside>

    <div class="main-content">
        <div class="container mx-auto px-6 py-6">
            <div class="mb-6">
                <h1 class="text-2xl font-bold text-gray-900 uppercase tracking-wide">My Lending</h1>
                <p class="text-gray-600 text-sm mt-1">Track and manage items you are lending out</p>
            </div>

            <div id="lendingList" class="space-y-3">
                <!-- Lending rentals will be injected here -->
            </div>
        </div>
    </div>

    <script src="/app.js"></script>
    <script src="/dashboard.js"></script>
    <script>
        if (!currentUser) {
            window.location.href = '/login.html';
        }

        function getPrimaryImage(images) {
            if (!images) {
                return '/assets/images/placeholder.jpg';
            }
            if (Array.isArray(images)) {
                const first = images.find((img) => typeof img === 'string' && img.trim().length > 0);
                return first || '/assets/images/placeholder.jpg';
            }
            if (typeof images === 'string') {
                try {
                    const parsed = JSON.parse(images);
                    if (Array.isArray(parsed)) {
                        const first = parsed.find((img) => typeof img === 'string' && img.trim().length > 0);
                        if (first) {
                            return first;
                        }
                    }
                    if (images.startsWith('data:image') || images.startsWith('http')) {
                        return images;
                    }
                } catch (error) {
                    if (images.startsWith('data:image') || images.startsWith('http')) {
                        return images;
                    }
                }
            }
            return '/assets/images/placeholder.jpg';
        }

        function formatDateDisplay(dateValue) {
            if (!dateValue) {
                return '—';
            }
            const date = new Date(dateValue);
            if (Number.isNaN(date.getTime())) {
                return '—';
            }
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatDateTimeDisplay(dateValue) {
            if (!dateValue) {
                return null;
            }
            const date = new Date(dateValue);
            if (Number.isNaN(date.getTime())) {
                return null;
            }
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getReturnDateInfo(rental) {
            const lenderConfirmed = rental.lender_confirmed_return_at;
            const borrowerConfirmed = rental.borrower_confirmed_return_at;
            const scheduled = rental.end_date || rental.endDate;

            if (lenderConfirmed) {
                return {
                    label: 'You confirmed the return',
                    value: formatDateTimeDisplay(lenderConfirmed)
                };
            }

            if (borrowerConfirmed) {
                return {
                    label: 'Borrower marked the return',
                    value: formatDateTimeDisplay(borrowerConfirmed)
                };
            }

            return {
                label: 'Scheduled return date',
                value: formatDateDisplay(scheduled)
            };
        }

        function checkBankAccountInfo() {
            if (!currentUser.bank_acc_name || !currentUser.bank_number || !currentUser.bank_name) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Bank Account Required',
                    html: `
                        <p class="text-gray-700 mb-4">You need to fill in your bank account information to access this page.</p>
                        <p class="text-sm text-gray-600">This information is required for rental transactions.</p>
                    `,
                    confirmButtonText: 'Go to Profile',
                    confirmButtonColor: '#0d9488',
                    allowOutsideClick: false,
                    allowEscapeKey: false
                }).then(() => {
                    window.location.href = '/profile.html';
                });
                return false;
            }
            return true;
        }

        if (currentUser) {
            document.getElementById('sidebarUserName').textContent = currentUser.name || 'User';
            document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Admin' : 'Member';
            document.getElementById('userAvatar').textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
        }

        async function loadLending() {
            try {
                const response = await api.getMyLending();
                const rentals = response.data || [];
                await displayLending(rentals);
            } catch (error) {
                console.error('Error loading lending:', error);
                Swal.fire('Error', 'Failed to load lending history', 'error');
            }
        }

        async function displayLending(rentals) {
            const lendingList = document.getElementById('lendingList');

            if (!rentals || rentals.length === 0) {
                lendingList.innerHTML = `
                    <div class="bg-white p-8 rounded-lg shadow text-center">
                        <i data-lucide="hand-coins" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                        <p class="text-gray-600">No rental requests for your items yet.</p>
                        <a href="/list_new_item.html" class="btn-primary mt-4 inline-block">
                            List an Item
                        </a>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const statusConfig = {
                'pending': { color: 'bg-yellow-500', text: 'Awaiting Payment', icon: 'credit-card' },
                'payment_pending': { color: 'bg-yellow-500', text: 'Awaiting Payment', icon: 'credit-card' },
                'payment_made': { color: 'bg-blue-500', text: 'Payment Made', icon: 'check' },
                'approved': { color: 'bg-green-500', text: 'Approved', icon: 'check-circle' },
                'lender_confirmed': { color: 'bg-blue-500', text: 'Item Lended', icon: 'package-check' },
                'active': { color: 'bg-teal-500', text: 'Borrower In Use', icon: 'package' },
                'item_transferred': { color: 'bg-teal-500', text: 'Borrower In Use', icon: 'package' },
                'borrower_returned': { color: 'bg-orange-500', text: 'Borrower Returning', icon: 'rotate-ccw' },
                'return_completed': { color: 'bg-purple-500', text: 'Awaiting Refund', icon: 'clock' },
                'item_returned': { color: 'bg-purple-500', text: 'Item Returned', icon: 'clock' },
                'completed': { color: 'bg-blue-500', text: 'Completed', icon: 'check-circle-2' },
                'cancelled': { color: 'bg-gray-500', text: 'Cancelled', icon: 'ban' },
                'rejected': { color: 'bg-red-500', text: 'Rejected', icon: 'x-circle' }
            };

            lendingList.innerHTML = '';

            for (const rental of rentals) {
                const workflowStatus = rental.workflow_status || 'pending';
                let normalizedStatus = workflowStatus;
                if ((workflowStatus === 'payment_pending' || workflowStatus === 'pending') && rental.payment_date) {
                    normalizedStatus = 'payment_made';
                }
                const config = statusConfig[normalizedStatus] || { color: 'bg-yellow-500', text: 'Pending', icon: 'clock' };

                let hasReviewed = false;
                if (workflowStatus === 'completed') {
                    try {
                        const reviewCheck = await api.request(`/reviews/can-review/${rental.id}`);
                        hasReviewed = reviewCheck.hasReviewed || false;
                    } catch (error) {
                        console.error('Error checking review status:', error);
                    }
                }

                const itemNameSafe = (rental.itemName || 'Item').replace(/"/g, '&quot;');
                const primaryImage = getPrimaryImage(rental.images);
                const progressConfig = [
                    { key: 'lender_transfer_photo', label: 'Your handover proof', icon: 'camera' },
                    { key: 'borrower_return_photo', label: 'Borrower return proof', icon: 'rotate-ccw' },
                    { key: 'lender_return_photo', label: 'Your return confirmation', icon: 'shield-check' }
                ];
                const progressPhotos = progressConfig
                    .map((cfg) => {
                        const raw = rental[cfg.key];
                        const normalized = typeof raw === 'string' ? raw.trim() : '';
                        if (!normalized) {
                            return null;
                        }
                        return { ...cfg, src: normalized };
                    })
                    .filter(Boolean);
                const progressSection = progressPhotos.length
                    ? `<div class="grid grid-cols-2 gap-2">${progressPhotos.map((photo) => `
                            <div class="group">
                                <a href="${photo.src}" target="_blank" rel="noopener noreferrer" class="block overflow-hidden rounded-lg border border-gray-200">
                                    <img src="${photo.src}" alt="${photo.label}" class="w-full h-20 object-cover transition-transform duration-200 group-hover:scale-105" />
                                </a>
                                <p class="mt-1 text-[0.7rem] font-medium text-gray-700 flex items-center gap-1">
                                    <i data-lucide="${photo.icon}" class="w-3 h-3"></i>
                                    ${photo.label}
                                </p>
                            </div>
                        `).join('')}</div>`
                    : '<p class="text-xs text-gray-500 bg-gray-50 border border-dashed border-gray-200 rounded-lg p-3 text-center">No progress photos yet</p>';
                const returnInfo = getReturnDateInfo(rental);
                const returnValue = returnInfo.value || '—';

                const rentalHTML = `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition-shadow">
                    <div class="h-1 ${config.color}"></div>
                    <div class="p-4">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="md:w-56 w-full flex-shrink-0 space-y-3">
                                <div>
                                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide block mb-2">Item Photo</span>
                                    <a href="${primaryImage}" target="_blank" rel="noopener noreferrer" class="block rounded-lg overflow-hidden border border-gray-200">
                                        <img src="${primaryImage}" alt="${itemNameSafe} photo" class="w-full h-32 object-cover" />
                                    </a>
                                </div>
                                <div>
                                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wide block mb-2">Progress Photos</span>
                                    ${progressSection}
                                </div>
                            </div>
                            <div class="flex-1 flex flex-col gap-4">
                                <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                                    <div class="flex-1 min-w-0 space-y-4">
                                        <div>
                                            <span class="text-xs text-gray-400 uppercase tracking-wide font-semibold">Your Item</span>
                                            <h3 class="text-lg font-bold text-gray-900 truncate">${rental.itemName || 'Item'}</h3>
                                        </div>
                                        <div class="bg-gray-50 p-3 rounded-lg">
                                            <span class="text-xs text-gray-400 uppercase tracking-wide font-semibold mb-2 block">Borrower Details</span>
                                            <p class="text-sm text-gray-700 font-medium">
                                                <i data-lucide="user" class="w-4 h-4 inline mr-1 text-primary"></i>
                                                ${rental.borrowerName || 'Unknown'}
                                            </p>
                                            ${rental.borrowerEmail ? `
                                                <p class="text-xs text-gray-600 mt-1">
                                                    <i data-lucide="mail" class="w-3 h-3 inline mr-1"></i>
                                                    ${rental.borrowerEmail}
                                                </p>
                                            ` : ''}
                                            ${rental.borrowerPhone ? `
                                                <p class="text-xs text-gray-600 mt-1">
                                                    <i data-lucide="phone" class="w-3 h-3 inline mr-1"></i>
                                                    ${rental.borrowerPhone}
                                                </p>
                                            ` : ''}
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div>
                                                <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                                    <i data-lucide="calendar" class="w-3 h-3"></i>
                                                    Rental Period
                                                </p>
                                                <p class="text-sm font-semibold text-gray-800">
                                                    ${formatDateDisplay(rental.start_date || rental.startDate)} - ${formatDateDisplay(rental.end_date || rental.endDate)}
                                                </p>
                                            </div>
                                            <div>
                                                <p class="text-xs text-gray-500 mb-1 flex items-center gap-1">
                                                    <i data-lucide="calendar-clock" class="w-3 h-3"></i>
                                                    ${returnInfo.label}
                                                </p>
                                                <p class="text-sm font-semibold text-gray-800">${returnValue}</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-start lg:items-end gap-2">
                                        <div class="text-left lg:text-right">
                                            <p class="text-xs text-gray-500 uppercase tracking-wide">Total Amount</p>
                                            <p class="text-2xl font-bold text-gray-900">฿${parseFloat(rental.total_price || rental.totalPrice || 0).toFixed(2)}</p>
                                        </div>
                                        <span class="inline-flex items-center gap-1.5 px-3 py-1 ${config.color} text-white text-xs font-bold rounded uppercase tracking-wide">
                                            <i data-lucide="${config.icon}" class="w-3.5 h-3.5"></i>
                                            ${config.text}
                                        </span>
                                    </div>
                                </div>
                                ${workflowStatus === 'approved' && !rental.lender_confirmed_transfer ? `
                                    <div class="pt-3 border-t border-gray-100">
                                        <button onclick="confirmItemLended(${rental.id})" 
                                            class="w-full bg-blue-600 text-white px-5 py-3 rounded-lg hover:bg-blue-700 transition-colors font-bold uppercase tracking-wide text-sm flex items-center justify-center gap-2">
                                            <i data-lucide="hand-coins" class="w-5 h-5"></i>
                                            Confirm Item Lended
                                        </button>
                                        <p class="text-xs text-gray-600 text-center mt-2">Click after you give the item to the borrower.</p>
                                    </div>
                                ` : workflowStatus === 'lender_confirmed' ? `
                                    <div class="pt-3 border-t border-gray-100">
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                                            <p class="text-sm text-blue-800 font-semibold">
                                                <i data-lucide="clock" class="w-4 h-4 inline mr-1"></i>
                                                Waiting for borrower to confirm receipt
                                            </p>
                                        </div>
                                    </div>
                                ` : workflowStatus === 'active' || workflowStatus === 'item_transferred' ? `
                                    <div class="pt-3 border-t border-gray-100">
                                        <div class="bg-teal-50 border border-teal-200 rounded-lg p-3 text-center">
                                            <p class="text-sm text-teal-800 font-semibold">
                                                <i data-lucide="package" class="w-4 h-4 inline mr-1"></i>
                                                Item is currently being used by borrower
                                            </p>
                                        </div>
                                    </div>
                                ` : workflowStatus === 'borrower_returned' ? `
                                    <div class="pt-3 border-t border-gray-100">
                                        <button onclick="confirmReturnReceived(${rental.id})" 
                                            class="w-full bg-green-600 text-white px-5 py-3 rounded-lg hover:bg-green-700 transition-colors font-bold uppercase tracking-wide text-sm flex items-center justify-center gap-2">
                                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                                            Confirm Received Item Back
                                        </button>
                                        <p class="text-xs text-gray-600 text-center mt-2">Click after the borrower returns the item to you.</p>
                                    </div>
                                ` : workflowStatus === 'return_completed' ? `
                                    <div class="pt-3 border-t border-gray-100">
                                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                            <p class="text-sm text-green-800 font-semibold">
                                                <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i>
                                                Item return confirmed! Waiting for deposit refund processing.
                                            </p>
                                        </div>
                                    </div>
                                ` : workflowStatus === 'completed' ? `
                                    <div class="pt-3 border-t border-gray-100 space-y-2">
                                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-center">
                                            <p class="text-sm text-blue-800 font-semibold">
                                                <i data-lucide="check-circle-2" class="w-4 h-4 inline mr-1"></i>
                                                Rental completed successfully! Deposit has been refunded.
                                            </p>
                                        </div>
                                        ${hasReviewed ? `
                                            <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-center">
                                                <p class="text-sm text-green-800 font-semibold">
                                                    <i data-lucide="check-circle-2" class="w-4 h-4 inline mr-1"></i>
                                                    Review Completed ✓
                                                </p>
                                            </div>
                                        ` : `
                                            <button onclick="openReviewModal(${rental.id}, ${rental.borrower_id}, '${rental.borrowerName}', '${rental.itemName}')" 
                                                class="w-full bg-amber-600 text-white px-5 py-3 rounded-lg hover:bg-amber-700 transition-colors font-bold uppercase tracking-wide text-sm flex items-center justify-center gap-2">
                                                <i data-lucide="star" class="w-5 h-5"></i>
                                                Review Borrower
                                            </button>
                                        `}
                                    </div>
                                ` : workflowStatus === 'cancelled' ? `
                                    <div class="pt-3 border-t border-gray-100">
                                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 text-center">
                                            <p class="text-sm text-gray-700 font-semibold">
                                                <i data-lucide="x-circle" class="w-4 h-4 inline mr-1"></i>
                                                Rental was cancelled by borrower.
                                            </p>
                                        </div>
                                    </div>
                                ` : workflowStatus === 'rejected' ? `
                                    <div class="pt-3 border-t border-gray-100">
                                        <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                                            <p class="text-sm text-red-800 font-semibold">
                                                <i data-lucide="alert-circle" class="w-4 h-4 inline mr-1"></i>
                                                Rental request was rejected.
                                            </p>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                `;

                lendingList.innerHTML += rentalHTML;
            }

            lucide.createIcons();
        }

        async function handleRentalAction(rentalId, action) {
            try {
                const result = await Swal.fire({
                    title: `${action === 'approve' ? 'Approve' : 'Reject'} Rental?`,
                    text: `Are you sure you want to ${action} this rental request?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: action === 'approve' ? '#10b981' : '#ef4444',
                    confirmButtonText: `Yes, ${action}`,
                    cancelButtonText: 'Cancel'
                });

                if (result.isConfirmed) {
                    await api.updateRentalStatus(rentalId, action === 'approve' ? 'approved' : 'rejected');
                    Swal.fire('Success!', `Rental ${action}d successfully`, 'success');
                    loadLending();
                }
            } catch (error) {
                console.error('Error updating rental:', error);
                Swal.fire('Error', 'Failed to update rental', 'error');
            }
        }

        function compressImage(file, maxWidth = 1200, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        async function confirmItemLended(rentalId) {
            let handoverPhoto = null;
            const result = await Swal.fire({
                title: 'Confirm Item Lended?',
                html: `
                    <p class="text-gray-700 mb-4">Have you given the item to the borrower?</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-left">
                        <p class="text-sm text-blue-800">
                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                            <strong>Important:</strong> Only confirm after you have physically handed over the item to the borrower.
                        </p>
                    </div>
                    <div class="text-left mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Upload Photo of Item Handover <span class="text-red-500">*</span>
                        </label>
                        <input type="file" id="handoverPhotoInput" accept="image/*" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-md file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-50 file:text-blue-700
                            hover:file:bg-blue-100"/>
                        <p class="text-xs text-gray-500 mt-1">Take a clear photo showing the borrower receiving the item.</p>
                        <div id="handoverPhotoPreview" class="mt-3 hidden">
                            <img id="handoverPhotoImg" class="w-full rounded-lg border border-gray-200" />
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, Item Lended',
                cancelButtonText: 'Not Yet',
                didOpen: () => {
                    lucide.createIcons();
                    const input = document.getElementById('handoverPhotoInput');
                    const preview = document.getElementById('handoverPhotoPreview');
                    const img = document.getElementById('handoverPhotoImg');

                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            handoverPhoto = await compressImage(file, 1200, 0.8);
                            img.src = handoverPhoto;
                            preview.classList.remove('hidden');
                        } else {
                            handoverPhoto = null;
                            preview.classList.add('hidden');
                            img.removeAttribute('src');
                        }
                    });
                },
                preConfirm: () => {
                    if (!handoverPhoto) {
                        Swal.showValidationMessage('Please upload a photo of the handover before confirming');
                        return false;
                    }

                    return { handoverPhoto };
                }
            });

            if (result.isConfirmed && result.value) {
                try {
                    const response = await api.request('/rentals/confirm-lended', {
                        method: 'POST',
                        body: JSON.stringify({ 
                            rental_id: rentalId,
                            lender_transfer_photo: result.value.handoverPhoto
                        })
                    });

                    if (response.success) {
                        Swal.fire({
                            title: 'Success!',
                            text: 'Item lended confirmed. Borrower will be notified to confirm receipt.',
                            icon: 'success',
                            confirmButtonColor: '#0d9488'
                        });
                        loadLending();
                    }
                } catch (error) {
                    console.error('Error confirming item lended:', error);
                    Swal.fire('Error', error.message || 'Failed to confirm item lended', 'error');
                }
            }
        }

        async function confirmReturnReceived(rentalId) {
            let returnPhoto = null;
            const result = await Swal.fire({
                title: 'Confirm Received Item Back?',
                html: `
                    <p class="text-gray-700 mb-4">Has the borrower returned the item to you in good condition?</p>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3 text-left mb-4">
                        <p class="text-sm text-green-800">
                            <i data-lucide="info" class="w-4 h-4 inline mr-1"></i>
                            <strong>Important:</strong> Only confirm after you have physically received the item back from the borrower.
                        </p>
                    </div>
                    <div class="text-left">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Upload Photo of Returned Item (Optional)
                        </label>
                        <input type="file" id="returnPhotoInput" accept="image/*" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-md file:border-0
                            file:text-sm file:font-semibold
                            file:bg-green-50 file:text-green-700
                            hover:file:bg-green-100"/>
                        <div id="returnPhotoPreview" class="mt-3 hidden">
                            <img id="returnPhotoImg" class="w-full rounded-lg border border-gray-200" />
                        </div>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#16a34a',
                cancelButtonColor: '#6b7280',
                confirmButtonText: 'Yes, I have the item',
                cancelButtonText: 'Not Yet',
                didOpen: () => {
                    lucide.createIcons();
                    const input = document.getElementById('returnPhotoInput');
                    const preview = document.getElementById('returnPhotoPreview');
                    const img = document.getElementById('returnPhotoImg');

                    input.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            returnPhoto = await compressImage(file, 1200, 0.8);
                            img.src = returnPhoto;
                            preview.classList.remove('hidden');
                        } else {
                            returnPhoto = null;
                            preview.classList.add('hidden');
                            img.removeAttribute('src');
                        }
                    });
                },
                preConfirm: () => ({ returnPhoto })
            });

            if (result.isConfirmed) {
                try {
                    const response = await api.request('/rentals/confirm-return-received', {
                        method: 'POST',
                        body: JSON.stringify({
                            rental_id: rentalId,
                            return_photo: result.value?.returnPhoto || null
                        })
                    });

                    if (response.success) {
                        Swal.fire({
                            title: 'Return Confirmed',
                            text: 'Thank you for confirming the item return.',
                            icon: 'success',
                            confirmButtonColor: '#0d9488'
                        });
                        loadLending();
                    }
                } catch (error) {
                    console.error('Error confirming item return:', error);
                    Swal.fire('Error', error.message || 'Failed to confirm item return', 'error');
                }
            }
        }

        async function openReviewModal(rentalId, revieweeId, revieweeName, itemName) {
            const formValues = await Swal.fire({
                title: 'Review Borrower',
                html: `
                    <div class="text-left space-y-4">
                        <div>
                            <p class="text-sm text-gray-600">Share your experience with <strong>${revieweeName}</strong> for the item <strong>${itemName}</strong>.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Rating</label>
                            <div class="flex gap-1">
                                <button type="button" class="star-btn text-gray-300 hover:text-amber-400" onclick="setRating(1)">
                                    <i data-lucide="star" class="w-6 h-6"></i>
                                </button>
                                <button type="button" class="star-btn text-gray-300 hover:text-amber-400" onclick="setRating(2)">
                                    <i data-lucide="star" class="w-6 h-6"></i>
                                </button>
                                <button type="button" class="star-btn text-gray-300 hover:text-amber-400" onclick="setRating(3)">
                                    <i data-lucide="star" class="w-6 h-6"></i>
                                </button>
                                <button type="button" class="star-btn text-gray-300 hover:text-amber-400" onclick="setRating(4)">
                                    <i data-lucide="star" class="w-6 h-6"></i>
                                </button>
                                <button type="button" class="star-btn text-gray-300 hover:text-amber-400" onclick="setRating(5)">
                                    <i data-lucide="star" class="w-6 h-6"></i>
                                </button>
                            </div>
                            <input type="hidden" id="ratingValue" value="0" />
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Your Review</label>
                            <textarea id="reviewComment" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" rows="4" placeholder="Share your experience..."></textarea>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Submit Review',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#0d9488',
                cancelButtonColor: '#6b7280',
                width: '600px',
                preConfirm: () => {
                    const rating = document.getElementById('ratingValue').value;
                    const comment = document.getElementById('reviewComment').value;

                    if (!rating || rating == 0) {
                        Swal.showValidationMessage('Please select a rating');
                        return false;
                    }

                    if (!comment.trim()) {
                        Swal.showValidationMessage('Please write a review');
                        return false;
                    }

                    return { rating: parseInt(rating), comment: comment.trim() };
                },
                didOpen: () => {
                    lucide.createIcons();
                    window.setRating = function(star) {
                        document.getElementById('ratingValue').value = star;
                        const stars = document.querySelectorAll('.star-btn');
                        stars.forEach((btn, index) => {
                            if (index < star) {
                                btn.classList.remove('text-gray-300');
                                btn.classList.add('text-amber-400');
                            } else {
                                btn.classList.remove('text-amber-400');
                                btn.classList.add('text-gray-300');
                            }
                        });
                    };
                }
            });

            if (formValues) {
                try {
                    const response = await api.request('/reviews', {
                        method: 'POST',
                        body: JSON.stringify({
                            rental_id: rentalId,
                            reviewee_id: revieweeId,
                            rating: formValues.rating,
                            comment: formValues.comment
                        })
                    });

                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Review Submitted!',
                            text: 'Thank you for your feedback.',
                            confirmButtonColor: '#0d9488'
                        });
                        loadLending();
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'Failed to submit review. Please try again.',
                        confirmButtonColor: '#ef4444'
                    });
                }
            }
        }

        async function loadNotifications() {
            try {
                const response = await api.request('/notifications/unread/count');
                const count = response.count || 0;

                const badge = document.getElementById('notificationBadge');
                if (count > 0) {
                    badge.textContent = count > 9 ? '9+' : count;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        async function showNotificationsModal() {
            try {
                const response = await api.request('/notifications');
                const notifications = response.data || response || [];

                if (notifications.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No Notifications',
                        text: 'You have no notifications at this time.',
                        confirmButtonColor: '#0d9488'
                    });
                    return;
                }

                const notificationList = notifications.map(notification => `
                    <div class="border-b border-gray-200 pb-3 mb-3 text-left ${notification.is_read ? 'opacity-60' : ''}">
                        <div class="flex items-start justify-between gap-2">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-900">${notification.title}</h4>
                                <p class="text-sm text-gray-600 mt-1">${notification.message}</p>
                                <p class="text-xs text-gray-400 mt-1">${new Date(notification.created_at).toLocaleDateString()}</p>
                            </div>
                            ${!notification.is_read ? '<span class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-1"></span>' : ''}
                        </div>
                    </div>
                `).join('');

                Swal.fire({
                    title: 'Notifications',
                    html: `
                        <div class="max-h-96 overflow-y-auto">
                            ${notificationList}
                        </div>
                    `,
                    width: '600px',
                    confirmButtonText: 'Close',
                    confirmButtonColor: '#0d9488',
                    didOpen: () => {
                        api.request('/notifications/mark-read', { method: 'PUT' }).then(() => {
                            loadNotifications();
                        });
                    }
                });
            } catch (error) {
                console.error('Error showing notifications:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to load notifications',
                    confirmButtonColor: '#ef4444'
                });
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();

            try {
                const response = await api.getProfile();
                if (response.success && response.data) {
                    currentUser = response.data;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    document.getElementById('sidebarUserName').textContent = currentUser.name || 'User';
                    document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Admin' : 'Member';
                    document.getElementById('userAvatar').textContent = (currentUser.name || 'U').charAt(0).toUpperCase();
                }
            } catch (error) {
                console.error('Error refreshing user data:', error);
            }

            const hasBank = checkBankAccountInfo();
            if (!hasBank) return;

            await loadLending();
            await loadNotifications();

            setInterval(loadNotifications, 30000);
        });
    </script>
</body>
</html>
