<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lender Verification - RentMate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0d9488',
                        secondary: '#0f766e',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Manrope', sans-serif; }
        
        .btn-primary {
            padding: 0.625rem 1.25rem;
            background-color: #0d9488;
            color: white;
            font-weight: 500;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #0f766e;
            transform: scale(1.05);
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #0d9488;
            background-color: #f0fdfa;
        }

        .file-upload-area.dragover {
            border-color: #0d9488;
            background-color: #ccfbf1;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <a href="/dashboard.html" class="flex items-center space-x-2 text-primary font-bold text-xl">
                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    <span>Back to Dashboard</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-3xl mx-auto px-4 py-12">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Become a Member</h1>
                <p class="text-gray-600">Become a Verified Lender</p>
            </div>

            <!-- Info Box -->
            <div id="infoBox" class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
                <div class="flex">
                    <i data-lucide="info" class="w-6 h-6 text-blue-500 mr-3 flex-shrink-0 mt-1"></i>
                    <div>
                        <h3 class="font-semibold text-blue-900 mb-2">Why Verification is Required</h3>
                        <ul class="text-sm text-blue-800 space-y-2">
                            <li class="flex items-start">
                                <i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                                <span>Build trust with borrowers by verifying your identity</span>
                            </li>
                            <li class="flex items-start">
                                <i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                                <span>Protect both lenders and borrowers from fraud</span>
                            </li>
                            <li class="flex items-start">
                                <i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                                <span>Comply with platform regulations and policies</span>
                            </li>
                            <li class="flex items-start">
                                <i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                                <span>Get access to lender-specific features and analytics</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Waiting for Approval Section (Hidden by default) -->
            <div id="waitingSection" class="hidden text-center">
                
                <h2 class="text-2xl font-bold text-gray-800 mb-3">Verification Pending</h2>
                <p class="text-gray-600 mb-6">Your verification documents have been submitted successfully.</p>
                
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-6 mb-6">
                    <div class="flex items-start">
                        <i data-lucide="info" class="w-6 h-6 text-amber-600 mr-3 flex-shrink-0 mt-1"></i>
                        <div class="text-left">
                            <h3 class="font-semibold text-amber-900 mb-2">What's Next?</h3>
                            <ul class="text-sm text-amber-800 space-y-2">
                                <li class="flex items-start">
                                    <i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                                    <span>Our admin team is reviewing your documents</span>
                                </li>
                                <li class="flex items-start">
                                    <i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                                    <span>Verification typically takes 24-48 hours</span>
                                </li>
                                <li class="flex items-start">
                                    <i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                                    <span>You'll receive a notification once approved</span>
                                </li>
                                <li class="flex items-start">
                                    <i data-lucide="check" class="w-4 h-4 mr-2 mt-0.5 flex-shrink-0"></i>
                                    <span>You can continue browsing and borrowing items</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Verification Details -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6 mb-6">
                    <h3 class="font-semibold text-gray-800 mb-4">Submitted Information</h3>
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Status:</span>
                            <span class="px-3 py-1 bg-amber-100 text-amber-800 rounded-full font-medium">
                                <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>
                                Pending Review
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Submitted:</span>
                            <span class="text-gray-800 font-medium" id="submittedDate">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Passport/ID Number:</span>
                            <span class="text-gray-800 font-medium" id="displayPassportNo">-</span>
                        </div>
                    </div>
                </div>

                <a href="/dashboard.html" class="btn-primary inline-flex items-center px-6 py-3">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                    Return to Dashboard
                </a>
            </div>

            <!-- Verification Form -->
            <form id="verificationForm" onsubmit="handleSubmit(event)" class="hidden">
                <!-- Passport Number -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-lucide="credit-card" class="w-4 h-4 inline mr-1"></i>
                        Passport Number / National ID Number *
                    </label>
                    <input 
                        type="text" 
                        id="passportNo"
                        placeholder="Enter your passport or ID number"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" 
                        required
                    >
                    <p class="mt-2 text-xs text-gray-500">
                        <i data-lucide="shield-check" class="w-3 h-3 inline mr-1"></i>
                        Your information is encrypted and securely stored
                    </p>
                </div>

                <!-- Passport Image Upload -->
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-lucide="upload" class="w-4 h-4 inline mr-1"></i>
                        Upload Passport/ID Photos * (Multiple photos allowed)
                    </label>
                    
                    <div class="file-upload-area" id="uploadArea">
                        <input 
                            type="file" 
                            id="passportImage" 
                            accept="image/*"
                            multiple
                            class="hidden"
                            required
                        >
                        <div id="uploadPlaceholder">
                            <img src="../assets/images/passportscan.gif" alt="Passport Scan" class="w-40 h-40 mx-auto mb-3 opacity-80">
                            <p class="text-gray-600 font-medium mb-1">Click to upload or drag and drop</p>
                            <p class="text-sm text-gray-500">PNG, JPG or JPEG (MAX. 5MB each) - Multiple photos allowed</p>
                        </div>
                        <div id="uploadPreview" class="hidden">
                            <div id="previewContainer" class="grid grid-cols-2 gap-4 mb-3"></div>
                            <button type="button" onclick="clearAllFiles()" class="text-sm text-red-500 hover:text-red-700 mt-2">
                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                Remove All
                            </button>
                        </div>
                    </div>
                    <p class="mt-2 text-xs text-gray-500">
                        You can upload multiple photos. Please ensure all photos are clear and details are visible.
                    </p>
                </div>

                <!-- Privacy Notice -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <div class="flex items-start">
                        <i data-lucide="lock" class="w-5 h-5 text-gray-500 mr-3 mt-0.5 flex-shrink-0"></i>
                        <p class="text-sm text-gray-600">
                            Your verification documents will be reviewed by our admin team within 24-48 hours. 
                            All information is stored securely and will only be used for verification purposes.
                        </p>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-primary w-full py-3 text-base">
                    <i data-lucide="send" class="w-4 h-4 inline mr-2"></i>
                    Submit for Verification
                </button>
            </form>
        </div>
    </div>

    <script src="./app.js"></script>
    <script>
        lucide.createIcons();

        let selectedFiles = [];

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('passportImage');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');
        const uploadPreview = document.getElementById('uploadPreview');
        const previewContainer = document.getElementById('previewContainer');

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                handleFileSelect(files);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(Array.from(e.target.files));
            }
        });

        function handleFileSelect(files) {
            for (let file of files) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    ui.showNotification(`${file.name} is not an image file`, 'error');
                    continue;
                }

                // Validate file size (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    ui.showNotification(`${file.name} exceeds 5MB limit`, 'error');
                    continue;
                }

                selectedFiles.push(file);
            }

            updatePreview();
        }

        function updatePreview() {
            if (selectedFiles.length === 0) {
                uploadPlaceholder.classList.remove('hidden');
                uploadPreview.classList.add('hidden');
                previewContainer.innerHTML = '';
                return;
            }

            uploadPlaceholder.classList.add('hidden');
            uploadPreview.classList.remove('hidden');
            previewContainer.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const previewDiv = document.createElement('div');
                    previewDiv.className = 'relative group';
                    previewDiv.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-32 object-cover rounded-lg border-2 border-gray-300">
                        <button type="button" onclick="removeFileAtIndex(${index})" 
                            class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                        <p class="text-xs text-gray-600 mt-1 truncate">${file.name}</p>
                    `;
                    previewContainer.appendChild(previewDiv);
                    lucide.createIcons();
                };
                reader.readAsDataURL(file);
            });
        }

        function removeFileAtIndex(index) {
            selectedFiles.splice(index, 1);
            updatePreview();
            lucide.createIcons();
        }

        function clearAllFiles() {
            selectedFiles = [];
            fileInput.value = '';
            updatePreview();
            lucide.createIcons();
        }

        async function handleSubmit(event) {
            event.preventDefault();

            const passportNo = document.getElementById('passportNo').value;

            if (selectedFiles.length === 0) {
                ui.showNotification('Please upload at least one passport/ID photo', 'error');
                return;
            }

            try {
                // Convert all images to base64
                const imagePromises = selectedFiles.map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                });

                const base64Images = await Promise.all(imagePromises);

                const verificationData = {
                    passportNo: passportNo,
                    passportImages: base64Images // Array of base64 images
                };

                try {
                    const response = await api.submitLenderVerification(verificationData);
                    
                    if (response.success) {
                        ui.showNotification('Verification submitted successfully! Please wait for admin approval.', 'success');
                        // Update local user data
                        currentUser.verification_status = 'pending';
                        currentUser.passport_no = passportNo;
                        currentUser.passport_images = base64Images;
                        localStorage.setItem('user', JSON.stringify(currentUser));
                        
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        ui.showNotification(response.message || 'Failed to submit verification', 'error');
                    }
                } catch (error) {
                    console.error('Verification submission error:', error);
                    ui.showNotification(error.message || 'Failed to submit verification. Please try again.', 'error');
                }

            } catch (error) {
                console.error('File reading error:', error);
                ui.showNotification(error.message || 'Failed to read files. Please try again.', 'error');
            }
        }

        // Check if already verified
        if (!currentUser) {
            window.location.href = '/login.html';
        } else {
            const waitingSection = document.getElementById('waitingSection');
            const verificationForm = document.getElementById('verificationForm');
            const infoBox = document.getElementById('infoBox');
            const displayPassportNo = document.getElementById('displayPassportNo');
            const submittedDate = document.getElementById('submittedDate');

            if (currentUser.is_verified === 1 || currentUser.verification_status === 'verified') {
                ui.showNotification('You are already verified!', 'success');
                setTimeout(() => {
                    window.location.href = '/dashboard.html';
                }, 1500);
            } else if (currentUser.verification_status === 'pending') {
                // Show waiting section for ALL pending users
                waitingSection.classList.remove('hidden');
                verificationForm.classList.add('hidden');
                infoBox.classList.add('hidden');
                
                // Display user info if available
                if (displayPassportNo) {
                    displayPassportNo.textContent = currentUser.passport_no || 'Submitted';
                }
                
                // Format and display submission date
                if (submittedDate && currentUser.created_at) {
                    const date = new Date(currentUser.created_at);
                    submittedDate.textContent = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                }
                
                lucide.createIcons();
            } else {
                // Show form for new verification (users who haven't started verification)
                waitingSection.classList.add('hidden');
                verificationForm.classList.remove('hidden');
                infoBox.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>
